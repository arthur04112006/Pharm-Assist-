{% extends "base.html" %}

{% block title %}Iniciar Triagem - {{ paciente.nome }}{% endblock %}

{% block extra_css %}
<style>
    .question-container {
        min-height: 400px;
    }
    
    .question-card {
        transition: all 0.3s ease;
    }
    
    .question-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .progress-bar {
        height: 8px;
        border-radius: 4px;
    }
    
    .answer-option {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .answer-option:hover {
        background-color: #e9ecef;
        transform: scale(1.02);
    }
    
    .answer-option.selected {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    
    .patient-info-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-outline-secondary:hover:not(.disabled) {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    
    .btn-outline-secondary.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .btn-primary:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }
    
    #question-counter {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-clipboard-pulse text-primary"></i>
        Triagem - {{ paciente.nome }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('visualizar_paciente', id=paciente.id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar ao Paciente
        </a>
    </div>
</div>

<!-- Informações do Paciente -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card patient-info-card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="card-title">
                            <i class="bi bi-person-circle"></i> Dados do Paciente
                        </h5>
                        <p class="mb-1"><strong>Nome:</strong> {{ paciente.nome }}</p>
                        <p class="mb-1"><strong>Idade:</strong> {{ paciente.idade }} anos</p>
                        <p class="mb-1"><strong>Sexo:</strong> 
                            {% if paciente.sexo == 'M' %}Masculino{% elif paciente.sexo == 'F' %}Feminino{% else %}Outro{% endif %}
                        </p>
                        {% if paciente.cidade or paciente.bairro %}
                        <p class="mb-1"><strong>Localização:</strong> 
                            {% if paciente.bairro %}{{ paciente.bairro }}{% endif %}{% if paciente.bairro and paciente.cidade %}, {% endif %}{% if paciente.cidade %}{{ paciente.cidade }}{% endif %}
                        </p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Peso:</strong> {{ paciente.peso|default('N/A') }} kg</p>
                        <p class="mb-1"><strong>Altura:</strong> {{ paciente.altura|default('N/A') }} m</p>
                        <p class="mb-1"><strong>Hábitos:</strong> 
                            {% if paciente.fuma %}Fumante{% endif %}{% if paciente.fuma and paciente.bebe %}, {% endif %}
                            {% if paciente.bebe %}Consome álcool{% endif %}
                            {% if not paciente.fuma and not paciente.bebe %}Nenhum hábito registrado{% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Container para informações do perfil do paciente (preenchido dinamicamente) -->
<div id="patient-info" class="row mb-3" style="display: none;">
    <div class="col-12">
        <!-- Informações do perfil serão inseridas aqui via JavaScript -->
    </div>
</div>

<!-- Seleção de Módulo (fallback aqui caso usuário venha sem seleção) -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">Módulo (sintoma)</label>
                        <select id="moduloSelectIniciar" class="form-select">
                            <option value="">-- selecione --</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <button type="button" id="carregarModuloBtn" class="btn btn-primary">
                            Carregar Perguntas do Módulo
                        </button>
                    </div>
                </div>
                <small class="text-muted">Selecione um módulo caso as perguntas oficiais não tenham sido carregadas automaticamente.</small>
            </div>
        </div>
    </div>
</div>

<!-- Progresso da Triagem -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Progresso da Triagem</h6>
                    <span class="badge bg-primary" id="progress-text">0 de 0</span>
                </div>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" id="progress-bar" 
                         style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Painel de Pontuação em Tempo Real -->
<div class="row mb-3" id="scoring-panel" style="display: none;">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Análise de Pontuação</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h5 class="text-primary mb-1" id="current-score">0.0</h5>
                            <small class="text-muted">Pontuação Atual</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h5 class="text-warning mb-1" id="risk-level">Baixo</h5>
                            <small class="text-muted">Nível de Risco</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h5 class="text-success mb-1" id="answered-count">0</h5>
                            <small class="text-muted">Perguntas Respondidas</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h5 class="text-info mb-1" id="confidence">0%</h5>
                            <small class="text-muted">Confiança</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Container das Perguntas -->
<div class="row">
    <div class="col-12">
        <div class="card question-container">
            <div class="card-body">
                <div id="questions-container">
                    <!-- As perguntas serão carregadas aqui via JavaScript -->
                </div>
                
                <!-- Botões de Navegação -->
                <div class="row mt-4" id="navigation-buttons" style="display: none;">
                    <div class="col-4">
                        <button type="button" class="btn btn-outline-secondary w-100" id="prev-btn" onclick="previousQuestion()">
                            <i class="bi bi-chevron-left"></i> Anterior
                            <small class="d-block text-muted">← Seta</small>
                        </button>
                    </div>
                    <div class="col-4 text-center">
                        <span class="badge bg-light text-dark fs-6" id="question-counter">
                            ${currentQuestionIndex + 1} de ${totalQuestions}
                        </span>
                        <div class="mt-1">
                            <small class="text-muted">
                                <i class="bi bi-keyboard"></i> Use as setas do teclado
                            </small>
                        </div>
                    </div>
                    <div class="col-4">
                        <button type="button" class="btn btn-primary w-100" id="next-btn" onclick="nextQuestion()">
                            Próxima <i class="bi bi-chevron-right"></i>
                            <small class="d-block text-white-50">Seta →</small>
                        </button>
                    </div>
                </div>
                
                <!-- Botão Finalizar -->
                <div class="row mt-4" id="finish-section" style="display: none;">
                    <div class="col-12 text-center">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Última pergunta!</strong> Verifique suas respostas antes de finalizar.
                        </div>
                        <button type="button" class="btn btn-success btn-lg px-5" onclick="finishTriagem()">
                            <i class="bi bi-check-circle-fill me-2"></i> Finalizar Triagem
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Finalização</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja finalizar a triagem?</p>
                <p class="text-muted">Após finalizar, o sistema gerará recomendações baseadas nas respostas.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmFinishTriagem()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Processando...</span>
                </div>
                <p class="mt-3">Processando triagem...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variáveis globais
let currentQuestionIndex = 0;
const moduloSlug = "{{ modulo or '' }}";
let questions = [];
let answers = {};
let totalQuestions = questions.length;

// Inicializar triagem
document.addEventListener('DOMContentLoaded', async function() {
    // Adicionar atalhos de teclado
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft' && !document.getElementById('prev-btn').disabled) {
            previousQuestion();
        } else if (e.key === 'ArrowRight' && document.getElementById('next-btn').style.display !== 'none') {
            nextQuestion();
        } else if (e.key === 'Enter' && document.getElementById('finish-section').style.display !== 'none') {
            finishTriagem();
        }
    });
    // Se um módulo (sintoma) foi selecionado, carregar perguntas oficiais via API
    let slug = moduloSlug;
    if (!slug) {
        // fallback: recuperar do localStorage (quando veio direto sem querystring)
        slug = localStorage.getItem('triagem_modulo_slug') || '';
    }
    // Popular lista de módulos no fallback selector
    try {
        const resMods = await fetch('/api/triagem/modulos');
        const mods = await resMods.json();
        const select = document.getElementById('moduloSelectIniciar');
        if (select) {
            select.innerHTML = '<option value="">-- selecione --</option>' + mods.map(m => `<option value="${m.slug}">${m.nome}</option>`).join('');
            if (slug) select.value = slug;
        }
        const btn = document.getElementById('carregarModuloBtn');
        if (btn && select) {
            btn.addEventListener('click', async function() {
                const chosen = select.value;
                if (chosen) {
                    localStorage.setItem('triagem_modulo_slug', chosen);
                    await loadQuestionsFromModule(chosen);
                    currentQuestionIndex = 0;
                    loadQuestion(currentQuestionIndex);
                    updateProgress();
                }
            });
        }
    } catch (e) {
        console.error('Erro ao carregar lista de módulos', e);
    }

    if (slug) {
        try {
            await loadQuestionsFromModule(slug);
        } catch (e) {
            console.error('Erro ao carregar perguntas do módulo', e);
        }
    }
    loadQuestion(currentQuestionIndex);
    updateProgress();
});

async function loadQuestionsFromModule(slug) {
    const pacienteId = {{ paciente.id }};
    const res = await fetch(`/api/triagem/perguntas?modulo=${encodeURIComponent(slug)}&paciente_id=${pacienteId}&filter_unnecessary=true`);
    const data = await res.json();
    if (data && data.success) {
        questions = data.perguntas || [];
        totalQuestions = questions.length;
        currentQuestionIndex = 0;
        
        // Exibir informações do perfil do paciente se disponível
        if (data.patient_profile) {
            console.log('Perfil do paciente:', data.patient_profile);
            // Aqui você pode exibir informações como idade, sexo, etc. na interface
            displayPatientInfo(data.patient_profile);
        }
        
        // Exibir mensagem se perguntas foram filtradas
        if (data.filtered) {
            console.log('Perguntas desnecessárias foram filtradas baseadas no cadastro do paciente');
        }
        
        // Inicializar painel de pontuação
        calculateRealTimeScore();
        
        // Carregar pergunta inicial
        loadQuestion(0);
        updateProgress();
    }
}

function displayPatientInfo(profile) {
    // Exibir informações do perfil do paciente na interface
    const infoContainer = document.getElementById('patient-info');
    if (infoContainer) {
        infoContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-success">
                    <h6><i class="bi bi-check-circle me-2"></i>Perguntas Otimizadas</h6>
                    <p class="mb-1">As perguntas foram filtradas automaticamente baseadas no cadastro do paciente.</p>
                    <p class="mb-0"><strong>Dados utilizados:</strong> Idade (${profile.age_years} anos), Sexo (${profile.sexo === 'M' ? 'Masculino' : profile.sexo === 'F' ? 'Feminino' : 'Outro'})${profile.is_frail_elderly ? ', Perfil (Idoso frágil)' : ''}</p>
                </div>
            </div>
        `;
        infoContainer.style.display = 'block';
    }
}

// Carregar pergunta
function loadQuestion(index) {
    if (index < 0 || index >= totalQuestions) return;
    
    const question = questions[index];
    const container = document.getElementById('questions-container');
    
    let answerOptions = '';
    
    // Gerar opções de resposta baseadas no tipo de pergunta
    const isBoolean = (question.tipo === 'boolean') || (question.tipo === 'sintoma') || (question.tipo === 'habito');
    const isNumber = (question.tipo === 'number') || (question.tipo === 'geral' && question.texto.toLowerCase().includes('intensidade'));

    if (isBoolean) {
        // Sim/Não para boolean/sintomas/hábitos
        const options = [
            { value: 'sim', label: 'Sim', icon: 'bi-check-circle-fill', color: 'success' },
            { value: 'nao', label: 'Não', icon: 'bi-x-circle-fill', color: 'danger' }
        ];
        
        options.forEach(option => {
            const selected = answers[question.id] === option.value ? 'selected' : '';
            answerOptions += `
                <div class="col-md-6">
                    <div class="answer-option border rounded p-4 text-center ${selected}" 
                         onclick="selectAnswer('${question.id}', '${option.value}')">
                        <i class="bi ${option.icon} fs-1 text-${option.color}"></i>
                        <br><strong>${option.label}</strong>
                    </div>
                </div>
            `;
        });
    } else if (isNumber) {
        // Campo numérico genérico
        const val = (answers[question.id] ?? '');
        answerOptions = `
            <div class="col-12">
                <input type="number" class="form-control" value="${val}"
                       placeholder="Digite um número" onchange="selectAnswer('${question.id}', this.value)" />
            </div>
        `;
    } else {
        // Campo de texto livre
        answerOptions = `
            <div class="col-12">
                <textarea class="form-control" rows="3" 
                          placeholder="Digite sua resposta aqui..."
                          onchange="selectAnswer('${question.id}', this.value)"
                          >${answers[question.id] || ''}</textarea>
            </div>
        `;
    }
    
    // Verificar se a pergunta foi respondida
    const isAnswered = answers[question.id] && answers[question.id].trim() !== '';
    const statusBadge = isAnswered ? 
        '<span class="badge bg-success ms-2"><i class="bi bi-check-circle"></i> Respondida</span>' : 
        '<span class="badge bg-warning ms-2"><i class="bi bi-exclamation-circle"></i> Pendente</span>';
    
    // Informações de pontuação
    const scoringInfo = question.scoring_info || {};
    const weightBadge = scoringInfo.peso ? 
        `<span class="badge bg-info ms-2" title="Peso da pergunta: ${scoringInfo.peso}">Peso: ${scoringInfo.peso}</span>` : '';
    const categoryBadge = scoringInfo.categoria ? 
        `<span class="badge bg-secondary ms-1" title="Categoria: ${scoringInfo.categoria}">${scoringInfo.categoria}</span>` : '';
    const criticalBadge = scoringInfo.critica ? 
        '<span class="badge bg-danger ms-1" title="Pergunta crítica - resposta positiva indica encaminhamento"><i class="bi bi-exclamation-triangle"></i> Crítica</span>' : '';
    
    container.innerHTML = `
        <div class="question-card">
            <h4 class="mb-4">
                <span class="badge bg-primary me-2">${index + 1}</span>
                ${question.texto}
                ${statusBadge}
                ${weightBadge}
                ${categoryBadge}
                ${criticalBadge}
            </h4>
            
            <div class="row">
                ${answerOptions}
            </div>
        </div>
    `;
    
    updateNavigationButtons();
}

// Selecionar resposta
function selectAnswer(questionId, answer) {
    answers[questionId] = answer;
    
    // Atualizar visualização se for opção selecionável
    const questionContainer = document.getElementById('questions-container');
    const options = questionContainer.querySelectorAll('.answer-option');
    
    options.forEach(option => {
        option.classList.remove('selected');
        if (option.onclick && option.onclick.toString().includes(answer)) {
            option.classList.add('selected');
        }
    });
    
    // Salvar resposta
    localStorage.setItem(`triagem_${questionId}`, answer);
    
    // Calcular pontuação em tempo real
    calculateRealTimeScore();
    
    // Recarregar a pergunta para atualizar o status visual
    loadQuestion(currentQuestionIndex);
}

// Navegar para próxima pergunta
function nextQuestion() {
    // Verificar se a pergunta atual foi respondida
    const currentQuestion = questions[currentQuestionIndex];
    if (currentQuestion && !answers[currentQuestion.id]) {
        alert('Por favor, responda a pergunta atual antes de continuar.');
        return;
    }
    
    if (currentQuestionIndex < totalQuestions - 1) {
        currentQuestionIndex++;
        loadQuestion(currentQuestionIndex);
        updateProgress();
    }
}

// Navegar para pergunta anterior
function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadQuestion(currentQuestionIndex);
        updateProgress();
    }
}

// Atualizar botões de navegação
function updateNavigationButtons() {
    const navButtons = document.getElementById('navigation-buttons');
    const finishSection = document.getElementById('finish-section');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const questionCounter = document.getElementById('question-counter');
    
    // Atualizar contador de perguntas
    if (questionCounter) {
        questionCounter.textContent = `${currentQuestionIndex + 1} de ${totalQuestions}`;
    }
    
    // Configurar botão anterior
    if (currentQuestionIndex === 0) {
        prevBtn.disabled = true;
        prevBtn.classList.add('disabled');
    } else {
        prevBtn.disabled = false;
        prevBtn.classList.remove('disabled');
    }
    
    // Configurar botão próxima/finalizar
    if (currentQuestionIndex === totalQuestions - 1) {
        nextBtn.style.display = 'none';
        finishSection.style.display = 'block';
    } else {
        nextBtn.style.display = 'block';
        finishSection.style.display = 'none';
    }
    
    navButtons.style.display = 'block';
}

// Atualizar barra de progresso
function updateProgress() {
    const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
    progressText.textContent = `${currentQuestionIndex + 1} de ${totalQuestions}`;
}

// Calcular pontuação em tempo real
function calculateRealTimeScore() {
    if (!questions || questions.length === 0) return;
    
    let totalScore = 0;
    let answeredCount = 0;
    let categoryScores = {
        sintoma: 0,
        gravidade: 0,
        duracao: 0,
        historico: 0,
        perfil: 0
    };
    
    // Calcular pontuação baseada nas respostas
    questions.forEach(question => {
        const answer = answers[question.id];
        if (answer && answer.trim() !== '') {
            answeredCount++;
            
            const scoringInfo = question.scoring_info || {};
            const peso = scoringInfo.peso || 1.0;
            const categoria = scoringInfo.categoria || 'sintoma';
            
            // Calcular peso da resposta
            let answerWeight = 0.5; // neutro
            if (answer.toLowerCase() === 'sim' || answer.toLowerCase() === 'yes') {
                answerWeight = 1.0;
            } else if (answer.toLowerCase() === 'não' || answer.toLowerCase() === 'no') {
                answerWeight = 0.0;
            } else if (!isNaN(answer)) {
                // Resposta numérica
                const numAnswer = parseFloat(answer);
                if (numAnswer > 0) {
                    answerWeight = Math.min(1.0, numAnswer / 10); // Normalizar para 0-1
                }
            }
            
            const questionScore = peso * answerWeight;
            totalScore += questionScore;
            
            if (categoryScores[categoria] !== undefined) {
                categoryScores[categoria] += questionScore;
            }
        }
    });
    
    // Determinar nível de risco
    let riskLevel = 'Baixo';
    if (totalScore >= 25) {
        riskLevel = 'Alto';
    } else if (totalScore >= 15) {
        riskLevel = 'Médio';
    }
    
    // Calcular confiança
    const confidence = totalQuestions > 0 ? Math.min(100, (answeredCount / totalQuestions) * 100) : 0;
    
    // Atualizar painel de pontuação
    updateScoringPanel(totalScore, riskLevel, answeredCount, confidence);
}

// Atualizar painel de pontuação
function updateScoringPanel(score, riskLevel, answeredCount, confidence) {
    const scoringPanel = document.getElementById('scoring-panel');
    const currentScoreEl = document.getElementById('current-score');
    const riskLevelEl = document.getElementById('risk-level');
    const answeredCountEl = document.getElementById('answered-count');
    const confidenceEl = document.getElementById('confidence');
    
    if (scoringPanel) {
        scoringPanel.style.display = 'block';
    }
    
    if (currentScoreEl) {
        currentScoreEl.textContent = score.toFixed(1);
        // Mudar cor baseada na pontuação
        currentScoreEl.className = 'text-primary mb-1';
        if (score >= 25) {
            currentScoreEl.className = 'text-danger mb-1';
        } else if (score >= 15) {
            currentScoreEl.className = 'text-warning mb-1';
        }
    }
    
    if (riskLevelEl) {
        riskLevelEl.textContent = riskLevel;
        // Mudar cor baseada no nível de risco
        riskLevelEl.className = 'text-success mb-1';
        if (riskLevel === 'Alto') {
            riskLevelEl.className = 'text-danger mb-1';
        } else if (riskLevel === 'Médio') {
            riskLevelEl.className = 'text-warning mb-1';
        }
    }
    
    if (answeredCountEl) {
        answeredCountEl.textContent = answeredCount;
    }
    
    if (confidenceEl) {
        confidenceEl.textContent = Math.round(confidence) + '%';
    }
}

// Finalizar triagem
function finishTriagem() {
    // Verificar se todas as perguntas foram respondidas
    const answeredQuestions = Object.keys(answers).length;
    if (answeredQuestions < totalQuestions) {
        alert(`Por favor, responda todas as perguntas. ${answeredQuestions}/${totalQuestions} respondidas.`);
        return;
    }
    
    // Mostrar modal de confirmação
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

// Confirmar finalização da triagem
function confirmFinishTriagem() {
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
    modal.hide();
    
    // Mostrar loading
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Preparar dados para envio
    const respostas = Object.keys(answers).map(qid => ({ pergunta_id: qid, resposta: answers[qid] }));
    
    // Obter módulo atual
    const moduloAtual = localStorage.getItem('triagem_modulo_slug') || moduloSlug || '';
    
    // Enviar dados para o servidor
    fetch('{{ url_for("processar_triagem") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            paciente_id: {{ paciente.id }},
            respostas: respostas,
            modulo: moduloAtual
        })
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();
        
        if (data.success) {
            // Redirecionar para resultado
            window.location.href = `/triagem/resultado/${data.consulta_id}`;
        } else {
            alert('Erro ao processar triagem: ' + data.error);
        }
    })
    .catch(error => {
        loadingModal.hide();
        alert('Erro ao processar triagem: ' + error);
    });
}

// Carregar respostas salvas do localStorage
function loadSavedAnswers() {
    questions.forEach(question => {
        const saved = localStorage.getItem(`triagem_${question.id}`);
        if (saved) {
            answers[question.id] = saved;
        }
    });
}

// Carregar respostas ao iniciar
loadSavedAnswers();
</script>
{% endblock %}
