{% extends "base.html" %}

{% block title %}Estat√≠sticas Avan√ßadas - Pharm-Assist{% endblock %}

{% block extra_css %}
<!-- Chart.js - Biblioteca de gr√°ficos interativos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* =====================================================
       ESTAT√çSTICAS AVAN√áADAS - ESTILOS PERSONALIZADOS
       
       Este arquivo cont√©m os estilos para a p√°gina de
       estat√≠sticas avan√ßadas com filtros din√¢micos e
       gr√°ficos interativos usando Chart.js.
       
       Estrutura:
       1. Painel de Filtros
       2. Cards de M√©tricas
       3. Cards de Gr√°ficos
       4. Loading States
       5. Responsividade
       ===================================================== */

    /* ==========================================
       1. PAINEL DE FILTROS
       √Årea superior com controles de filtro
       ========================================== */
    
    .filters-panel {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        border-left: 4px solid var(--primary-color); /* Borda azul usando vari√°vel do projeto */
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-group label {
        font-weight: 600;
        color: #475569;
        margin-bottom: 0.5rem;
        display: block;
    }

    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 0.95rem;
    }

    /* Efeito de foco nos campos de filtro */
    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: var(--primary-color); /* Usa cor prim√°ria do projeto */
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); /* Sombra azul sutil */
    }

    /* Bot√£o principal de aplicar filtros */
    .btn-filter {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); /* Gradiente azul do projeto */
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease; /* Transi√ß√£o suave */
    }

    /* Efeito hover no bot√£o de filtro */
    .btn-filter:hover {
        transform: translateY(-2px); /* Eleva o bot√£o */
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); /* Sombra mais intensa */
    }

    .btn-reset {
        background: white;
        color: var(--text-secondary);
        border: 2px solid #e2e8f0;
        padding: 0.75rem 2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-left: 0.5rem;
    }

    .btn-reset:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    /* ==========================================
       2. CARDS DE M√âTRICAS
       Cards informativos com anima√ß√µes hover
       ========================================== */
    
    .metric-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease; /* Transi√ß√£o suave para hover */
        border-left: 4px solid; /* Borda colorida √† esquerda */
        position: relative;
        overflow: hidden;
    }

    /* Efeito hover nos cards - eleva e aumenta sombra */
    .metric-card:hover {
        transform: translateY(-5px); /* Eleva o card */
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* Sombra mais pronunciada */
    }

    /* Card azul - Total de Consultas (usa cor prim√°ria do projeto) */
    .metric-card.primary {
        border-left-color: var(--primary-color);
    }

    /* Card verde - Taxa de Resolu√ß√£o (usa cor de sucesso do projeto) */
    .metric-card.success {
        border-left-color: var(--success-color);
    }

    /* Card azul claro - Pacientes Atendidos (usa cor info do projeto) */
    .metric-card.info {
        border-left-color: var(--info-color);
    }

    /* Card amarelo - Encaminhamentos (usa cor warning do projeto) */
    .metric-card.warning {
        border-left-color: var(--warning-color);
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .metric-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 500;
    }

    .metric-icon {
        font-size: 2rem;
        opacity: 0.3;
        float: right;
    }

    /* ==========================================
       3. CARDS DE GR√ÅFICOS
       Containers para os gr√°ficos Chart.js
       ========================================== */
    
    /* Card principal que cont√©m cada gr√°fico */
    .chart-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        transition: box-shadow 0.3s ease; /* Transi√ß√£o suave no hover */
    }

    /* Efeito hover sutil no card */
    .chart-card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* Header do card com t√≠tulo e bot√µes de op√ß√£o */
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f1f5f9;  /* Linha separadora sutil */
        flex-wrap: wrap;  /* Permite quebra em telas pequenas */
        gap: 1rem;
    }

    /* T√≠tulo do gr√°fico */
    .chart-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    /* Subt√≠tulo/descri√ß√£o do gr√°fico */
    .chart-subtitle {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    /* Container responsivo para gr√°ficos Chart.js */
    .chart-container {
        position: relative;
        height: 400px;  /* Altura padr√£o (ajustada por media queries) */
        margin: 1rem 0;
        width: 100%;    /* Largura total para responsividade */
    }

    /* Container dos bot√µes de tipo de gr√°fico (Linha/Barra/Pizza) */
    .chart-options {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;  /* Permite quebra em mobile */
    }

    /* Bot√µes de op√ß√£o de tipo de gr√°fico (Linha, Barra, Pizza) */
    .chart-option-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s ease;  /* Transi√ß√£o suave */
        font-weight: 500;
    }

    /* Estado ativo do bot√£o (tipo de gr√°fico selecionado) */
    .chart-option-btn.active {
        background: var(--primary-color);      /* Azul do projeto */
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);  /* Sombra azul */
    }

    /* Hover em bot√µes n√£o ativos */
    .chart-option-btn:hover:not(.active) {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: rgba(99, 102, 241, 0.05);  /* Fundo azul muito sutil */
    }

    /* ==========================================
       4. LOADING STATES
       Spinner animado durante carregamento de dados
       ========================================== */
    
    .loading-spinner {
        display: none;          /* Oculto por padr√£o, exibido via JavaScript */
        text-align: center;
        padding: 2rem;
    }

    /* Spinner circular rotativo */
    .spinner {
        border: 4px solid #f3f4f6;                  /* Borda cinza clara */
        border-top: 4px solid var(--primary-color); /* Topo azul (cor do projeto) */
        border-radius: 50%;                         /* Forma circular */
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;         /* Anima√ß√£o cont√≠nua */
        margin: 0 auto;
    }

    /* Anima√ß√£o de rota√ß√£o do spinner */
    @keyframes spin {
        0% { transform: rotate(0deg); }      /* In√≠cio: 0 graus */
        100% { transform: rotate(360deg); }  /* Fim: 360 graus (volta completa) */
    }

    /* Status Badge */
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-badge.success {
        background: #d1fae5;
        color: #065f46;
    }

    .status-badge.warning {
        background: #fef3c7;
        color: #92400e;
    }

    .status-badge.info {
        background: #dbeafe;
        color: #1e40af;
    }

    /* ==========================================
       5. RESPONSIVIDADE
       Ajustes para diferentes tamanhos de tela
       Mobile-first approach
       ========================================== */
    
    /* Tablets e dispositivos m√©dios (max-width: 992px) */
    @media (max-width: 992px) {
        /* Reduz padding do painel de filtros em tablets */
        .filters-panel {
            padding: 1rem;
        }
        
        /* Ajusta altura dos gr√°ficos para tablets */
        .chart-container {
            height: 350px;
        }
        
        /* Garante espa√ßamento entre cards de m√©tricas */
        .metric-card {
            margin-bottom: 1rem;
        }
        
        /* Ajusta t√≠tulo dos gr√°ficos */
        .chart-title {
            font-size: 1.1rem;
        }
    }
    
    /* Smartphones e dispositivos pequenos (max-width: 768px) */
    @media (max-width: 768px) {
        /* Reduz altura dos gr√°ficos em mobile para melhor visualiza√ß√£o */
        .chart-container {
            height: 300px;
        }
        
        /* Ajusta tamanho dos valores das m√©tricas para mobile */
        .metric-value {
            font-size: 1.75rem;
        }
        
        /* Reduz tamanho do t√≠tulo dos gr√°ficos */
        .chart-title {
            font-size: 1rem;
        }
        
        /* Subt√≠tulo menor em mobile */
        .chart-subtitle {
            font-size: 0.75rem;
        }
        
        /* Bot√µes de op√ß√£o de gr√°fico menores */
        .chart-option-btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
        }
        
        /* Filtros ocupam largura total */
        .filter-group {
            margin-bottom: 0.75rem;
        }
        
        /* Bot√µes de filtro em largura total */
        .btn-filter,
        .btn-reset {
            width: 100%;
            margin: 0.25rem 0;
        }
        
        /* Reduz padding dos cards */
        .chart-card {
            padding: 1rem;
        }
    }
    
    /* Dispositivos muito pequenos (max-width: 480px) */
    @media (max-width: 480px) {
        /* Altura m√≠nima para gr√°ficos em telas muito pequenas */
        .chart-container {
            height: 250px;
        }
        
        /* Valores das m√©tricas ainda menores para telas pequenas */
        .metric-value {
            font-size: 1.5rem;
        }
        
        /* √çcones das m√©tricas menores */
        .metric-icon {
            font-size: 1.5rem;
        }
        
        /* Padding reduzido nos cards */
        .chart-card,
        .metric-card {
            padding: 1rem;
        }
        
        /* Op√ß√µes de gr√°fico em coluna para telas pequenas */
        .chart-options {
            flex-direction: column;
            gap: 0.25rem;
            width: 100%;
        }
        
        /* Bot√µes de op√ß√£o ocupam largura total */
        .chart-option-btn {
            width: 100%;
        }
        
        /* Ajusta header do gr√°fico para mobile */
        .chart-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }
    
    /* Dispositivos com orienta√ß√£o paisagem (landscape) */
    @media (max-height: 600px) and (orientation: landscape) {
        /* Reduz altura dos gr√°ficos em modo paisagem */
        .chart-container {
            height: 250px;
        }
        
        /* Reduz padding vertical */
        .chart-card,
        .metric-card {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Cabe√ßalho -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-graph-up text-primary"></i>
        Estat√≠sticas Avan√ßadas
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
        </a>
    </div>
</div>

<!-- Painel de Filtros -->
<div class="filters-panel">
    <div class="row">
        <div class="col-md-3">
            <div class="filter-group">
                <label for="periodo-filter">
                    <i class="bi bi-calendar3"></i> Per√≠odo
                </label>
                <select id="periodo-filter" class="form-select">
                    <option value="dia">Hoje</option>
                    <option value="7dias">√öltimos 7 Dias</option>
                    <option value="30dias" selected>√öltimos 30 Dias</option>
                    <option value="90dias">√öltimos 90 Dias</option>
                    <option value="ano">√öltimo Ano</option>
                    <option value="personalizado">Personalizado</option>
                </select>
            </div>
        </div>
        
        <div class="col-md-3" id="data-inicio-group" style="display: none;">
            <div class="filter-group">
                <label for="data-inicio">
                    <i class="bi bi-calendar-check"></i> Data In√≠cio
                </label>
                <input type="date" id="data-inicio" class="form-control">
            </div>
        </div>
        
        <div class="col-md-3" id="data-fim-group" style="display: none;">
            <div class="filter-group">
                <label for="data-fim">
                    <i class="bi bi-calendar-check"></i> Data Fim
                </label>
                <input type="date" id="data-fim" class="form-control">
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="filter-group">
                <label for="limite-filter">
                    <i class="bi bi-list-ol"></i> Limite de Resultados
                </label>
                <select id="limite-filter" class="form-select">
                    <option value="5">Top 5</option>
                    <option value="10" selected>Top 10</option>
                    <option value="15">Top 15</option>
                    <option value="20">Top 20</option>
                </select>
            </div>
        </div>
        
        <div class="col-md-12 d-flex justify-content-center mt-3">
            <button class="btn-filter" onclick="aplicarFiltros()">
                <i class="bi bi-funnel"></i> Aplicar Filtros
            </button>
            <button class="btn-reset" onclick="resetarFiltros()">
                <i class="bi bi-x-circle"></i> Limpar
            </button>
        </div>
    </div>
</div>

<!-- Cards de M√©tricas -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card primary">
            <i class="bi bi-clipboard-pulse metric-icon"></i>
            <div class="metric-value" id="metric-consultas">--</div>
            <div class="metric-label">Total de Consultas</div>
            <div class="mt-2">
                <span class="status-badge info" id="periodo-badge">√öltimo M√™s</span>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card warning">
            <i class="bi bi-exclamation-triangle metric-icon"></i>
            <div class="metric-value" id="metric-encaminhamentos">--</div>
            <div class="metric-label">Encaminhamentos</div>
            <div class="mt-2">
                <span class="status-badge warning" id="taxa-encaminhamento">--</span>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card success">
            <i class="bi bi-check-circle metric-icon"></i>
            <div class="metric-value" id="metric-resolucao">--</div>
            <div class="metric-label">Taxa de Resolu√ß√£o</div>
            <div class="mt-2">
                <span class="status-badge success" id="taxa-resolucao-badge">--</span>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card info">
            <i class="bi bi-people metric-icon"></i>
            <div class="metric-value" id="metric-pacientes">--</div>
            <div class="metric-label">Pacientes Atendidos</div>
            <div class="mt-2">
                <span class="status-badge info" id="media-dia">--</span>
            </div>
        </div>
    </div>
</div>

<!-- Gr√°ficos -->
<div class="row">
    <!-- Gr√°fico de Consultas por Dia -->
    <div class="col-lg-8 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <div class="chart-title">
                        <i class="bi bi-graph-up-arrow text-primary"></i>
                        Consultas por Per√≠odo
                    </div>
                    <div class="chart-subtitle">Evolu√ß√£o temporal das consultas realizadas</div>
                </div>
                <div class="chart-options">
                    <button class="chart-option-btn active" data-chart="consultas" data-type="line">
                        <i class="bi bi-graph-up"></i> Linha
                    </button>
                    <button class="chart-option-btn" data-chart="consultas" data-type="bar">
                        <i class="bi bi-bar-chart"></i> Barras
                    </button>
                </div>
            </div>
            <div class="loading-spinner" id="loading-consultas">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="consultasChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Gr√°fico de Pacientes -->
    <div class="col-lg-4 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <div class="chart-title">
                        <i class="bi bi-people-fill text-success"></i>
                        Distribui√ß√£o de Pacientes
                    </div>
                    <div class="chart-subtitle">Por faixa et√°ria</div>
                </div>
                <div class="chart-options">
                    <button class="chart-option-btn active" data-chart="pacientes" data-agrupamento="faixa_etaria">
                        <i class="bi bi-person"></i> Idade
                    </button>
                    <button class="chart-option-btn" data-chart="pacientes" data-agrupamento="genero">
                        <i class="bi bi-gender-ambiguous"></i> G√™nero
                    </button>
                </div>
            </div>
            <div class="loading-spinner" id="loading-pacientes">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="pacientesChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gr√°fico de Medicamentos -->
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <div class="chart-title">
                        <i class="bi bi-capsule text-warning"></i>
                        Medicamentos Mais Recomendados
                    </div>
                    <div class="chart-subtitle">Ranking de medicamentos por frequ√™ncia de recomenda√ß√£o</div>
                </div>
                <div class="chart-options">
                    <button class="chart-option-btn active" data-chart="medicamentos" data-type="bar">
                        <i class="bi bi-bar-chart-fill"></i> Barras
                    </button>
                    <button class="chart-option-btn" data-chart="medicamentos" data-type="horizontalBar">
                        <i class="bi bi-bar-chart"></i> Horizontal
                    </button>
                </div>
            </div>
            <div class="loading-spinner" id="loading-medicamentos">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="medicamentosChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Novo: Gr√°fico de Sintomas por Faixa Et√°ria -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div style="flex: 1;">
                    <div class="chart-title">
                        <i class="bi bi-people-fill text-info"></i>
                        Sintomas por Faixa Et√°ria
                    </div>
                    <div class="chart-subtitle">Distribui√ß√£o de sintomas por grupos de idade</div>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Filtro de Sintoma -->
                    <select id="sintoma-filter" class="form-select" style="width: auto; min-width: 200px;">
                        <option value="todos">Todos os Sintomas</option>
                        <!-- Op√ß√µes ser√£o carregadas dinamicamente -->
                    </select>
                    
                    <!-- Filtro de Per√≠odo -->
                    <select id="sintoma-periodo-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="7dias">√öltimos 7 Dias</option>
                        <option value="30dias" selected>√öltimos 30 Dias</option>
                        <option value="90dias">√öltimos 90 Dias</option>
                        <option value="ano">√öltimo Ano</option>
                    </select>
                    
                    <!-- Tipo de Gr√°fico -->
                    <div class="chart-options">
                        <button class="chart-option-btn active" data-chart="sintomas" data-type="bar">
                            <i class="bi bi-bar-chart-fill"></i> Barras
                        </button>
                        <button class="chart-option-btn" data-chart="sintomas" data-type="doughnut">
                            <i class="bi bi-pie-chart-fill"></i> Pizza
                        </button>
                    </div>
                </div>
            </div>
            <div class="loading-spinner" id="loading-sintomas">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="sintomasChart"></canvas>
            </div>
            <!-- Badge de valida√ß√£o -->
            <div class="mt-3 text-center">
                <span id="validacao-badge" class="status-badge info" style="display: none;"></span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* =====================================================
   ESTAT√çSTICAS AVAN√áADAS - JAVASCRIPT
   
   Este arquivo cont√©m toda a l√≥gica JavaScript para:
   - Gerenciamento de filtros din√¢micos
   - Chamadas √†s APIs de estat√≠sticas
   - Cria√ß√£o e atualiza√ß√£o de gr√°ficos Chart.js
   - Manipula√ß√£o de eventos de UI
   
   Estrutura:
   1. Vari√°veis globais e configura√ß√µes
   2. Event listeners
   3. Fun√ß√µes de filtros
   4. Fun√ß√µes de carregamento de dados
   5. Fun√ß√µes de cria√ß√£o de gr√°ficos
   ===================================================== */

// ==========================================
// 1. VARI√ÅVEIS GLOBAIS E CONFIGURA√á√ïES
// ==========================================

// Inst√¢ncias dos gr√°ficos Chart.js (para atualiza√ß√£o din√¢mica)
let consultasChart = null;      // Gr√°fico de consultas por per√≠odo
let medicamentosChart = null;   // Gr√°fico de medicamentos mais recomendados
let pacientesChart = null;      // Gr√°fico de distribui√ß√£o de pacientes
let sintomasChart = null;       // Gr√°fico de sintomas por faixa et√°ria

// Configura√ß√µes padr√£o do Chart.js (aplica-se a todos os gr√°ficos)
Chart.defaults.font.family = 'Inter, sans-serif';  // Fonte consistente com o projeto
Chart.defaults.color = '#64748b';                  // Cor padr√£o de texto dos gr√°ficos

// ==========================================
// 2. EVENT LISTENERS
// Gerencia eventos de UI e intera√ß√µes do usu√°rio
// ==========================================

/**
 * Event Listener: Mudan√ßa no filtro de per√≠odo
 * Exibe/oculta campos de data personalizada conforme sele√ß√£o
 */
document.getElementById('periodo-filter').addEventListener('change', function() {
    const periodo = this.value;
    const dataInicioGroup = document.getElementById('data-inicio-group');
    const dataFimGroup = document.getElementById('data-fim-group');
    
    // Se per√≠odo personalizado for selecionado, mostra campos de data
    if (periodo === 'personalizado') {
        dataInicioGroup.style.display = 'block';
        dataFimGroup.style.display = 'block';
        
        // Definir datas padr√£o (hoje e um m√™s atr√°s)
        const hoje = new Date();
        const umMesAtras = new Date();
        umMesAtras.setMonth(umMesAtras.getMonth() - 1);
        
        document.getElementById('data-fim').valueAsDate = hoje;
        document.getElementById('data-inicio').valueAsDate = umMesAtras;
    } else {
        // Oculta campos de data para per√≠odos pr√©-definidos
        dataInicioGroup.style.display = 'none';
        dataFimGroup.style.display = 'none';
    }
});


// ==========================================
// 3. FUN√á√ïES DE FILTROS
// Gerenciam aplica√ß√£o e reset de filtros
// ==========================================

/**
 * Fun√ß√£o: aplicarFiltros
 * Aplica todos os filtros selecionados e recarrega todos os gr√°ficos
 * Chamada quando o usu√°rio clica em "Aplicar Filtros"
 */
function aplicarFiltros() {
    carregarDesempenho();               // Atualiza cards de m√©tricas
    carregarConsultas();                // Atualiza gr√°fico de consultas
    carregarMedicamentos();             // Atualiza gr√°fico de medicamentos
    carregarPacientes('faixa_etaria');  // Atualiza gr√°fico de pacientes
    carregarSintomas();                 // Atualiza gr√°fico de sintomas
}

/**
 * Fun√ß√£o: resetarFiltros
 * Restaura filtros para valores padr√£o e recarrega dados
 * Chamada quando o usu√°rio clica em "Limpar"
 */
function resetarFiltros() {
    // Restaurar valores padr√£o
    document.getElementById('periodo-filter').value = '30dias';
    document.getElementById('limite-filter').value = '10';
    
    // Ocultar campos de data personalizada
    document.getElementById('data-inicio-group').style.display = 'none';
    document.getElementById('data-fim-group').style.display = 'none';
    
    // Reaplicar filtros com valores padr√£o
    aplicarFiltros();
}

/**
 * Fun√ß√£o: getFiltroParams
 * Constr√≥i par√¢metros de URL baseado nos filtros selecionados
 * @returns {URLSearchParams} - Objeto com par√¢metros para requisi√ß√µes API
 */
function getFiltroParams() {
    const periodo = document.getElementById('periodo-filter').value;
    const params = new URLSearchParams();
    
    // Se per√≠odo personalizado, usa datas espec√≠ficas
    if (periodo === 'personalizado') {
        const dataInicio = document.getElementById('data-inicio').value;
        const dataFim = document.getElementById('data-fim').value;
        if (dataInicio && dataFim) {
            params.append('data_inicio', dataInicio);
            params.append('data_fim', dataFim);
        }
    } else {
        // Caso contr√°rio, usa per√≠odo pr√©-definido
        params.append('periodo', periodo);
    }
    
    // Usar m√©dia m√≥vel de 7 dias por padr√£o (acompanha a tend√™ncia)
    params.append('tipo_media', 'movel');
    params.append('janela_media', '7');
    
    return params;
}

// ==========================================
// 4. FUN√á√ïES DE CARREGAMENTO DE DADOS
// Fazem requisi√ß√µes √†s APIs e atualizam a UI
// ==========================================

/**
 * Fun√ß√£o: carregarDesempenho
 * Carrega m√©tricas de desempenho do sistema via API
 * Atualiza os 4 cards de m√©tricas no topo da p√°gina
 */
function carregarDesempenho() {
    const params = getFiltroParams();
    
    // Chamada √† API de desempenho
    fetch(`/api/estatisticas/desempenho?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const m = data.metricas;
                
                // Atualizar valores principais dos cards
                document.getElementById('metric-consultas').textContent = m.total_consultas;
                document.getElementById('metric-encaminhamentos').textContent = m.total_encaminhamentos;
                document.getElementById('metric-resolucao').textContent = m.taxa_resolucao + '%';
                document.getElementById('metric-pacientes').textContent = m.total_pacientes_atendidos;
                
                // Atualizar badges informativos
                document.getElementById('taxa-encaminhamento').textContent = m.taxa_encaminhamento + '% encaminhados';
                document.getElementById('taxa-resolucao-badge').textContent = m.taxa_resolucao + '% resolvidos';
                document.getElementById('media-dia').textContent = m.media_consultas_dia + ' consultas/dia';
                
                // Atualizar badge de per√≠odo selecionado
                const periodoTexto = {
                    'dia': 'Hoje',
                    '7dias': '√öltimos 7 Dias',
                    '30dias': '√öltimos 30 Dias',
                    '90dias': '√öltimos 90 Dias',
                    'semana': '√öltima Semana',
                    'mes': '√öltimo M√™s',
                    'ano': '√öltimo Ano',
                    'personalizado': 'Per√≠odo Personalizado'
                };
                document.getElementById('periodo-badge').textContent = periodoTexto[data.periodo] || '√öltimos 30 Dias';
            }
        })
        .catch(error => console.error('Erro ao carregar desempenho:', error));
}

/**
 * Fun√ß√£o: carregarConsultas
 * Carrega e renderiza gr√°fico de consultas por per√≠odo
 * @param {string} tipoGrafico - Tipo do gr√°fico ('line', 'bar', ou 'area')
 */
function carregarConsultas(tipoGrafico = 'line') {
    const params = getFiltroParams();
    const loading = document.getElementById('loading-consultas');
    loading.style.display = 'block';  // Exibe loading spinner
    
    fetch(`/api/estatisticas/consultas?${params}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('consultasChart').getContext('2d');
                
                // Destruir gr√°fico anterior se existir (evita duplica√ß√£o)
                if (consultasChart) {
                    consultasChart.destroy();
                }
                
                // ==========================================
                // 5. CRIA√á√ÉO DO GR√ÅFICO DE CONSULTAS
                // Usa Chart.js com cores do projeto
                // ==========================================
                
                // Criar gradiente para o gr√°fico
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)');
                gradient.addColorStop(0.5, 'rgba(99, 102, 241, 0.25)');
                gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

                // Criar datasets para o gr√°fico
                const datasets = [{
                    label: 'Consultas Realizadas',
                    data: data.dados.map(d => d.count),  // Quantidade de consultas
                    // Gradiente moderno para √°rea sob a linha
                    backgroundColor: tipoGrafico === 'line' ? gradient : 'rgba(99, 102, 241, 0.8)',
                    borderColor: '#6366f1',  // Azul prim√°rio
                    borderWidth: 3,  // Linha mais grossa
                    tension: 0.4,  // Suaviza√ß√£o da linha (curvas suaves)
                    fill: true,    // Preenche √°rea sob a linha
                    // Estilo dos pontos (marcadores)
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 9,  // Aumenta significativamente no hover
                    pointHoverBackgroundColor: '#4f46e5',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3,
                    // Sombra nos pontos
                    pointStyle: 'circle',
                    // Borda com gradiente
                    borderCapStyle: 'round',
                    borderJoinStyle: 'round',
                    order: 1  // Desenha primeiro (atr√°s)
                }];
                
                // Adicionar linha de m√©dia se dispon√≠vel
                if (data.dados.length > 0 && data.dados[0].media !== undefined) {
                    // Criar gradiente para a linha de m√©dia
                    const gradientMedia = ctx.createLinearGradient(0, 0, 0, 400);
                    gradientMedia.addColorStop(0, 'rgba(239, 68, 68, 0.2)');
                    gradientMedia.addColorStop(1, 'rgba(239, 68, 68, 0.0)');
                    
                    datasets.push({
                        label: data.tipo_media === 'movel' 
                            ? `M√©dia M√≥vel (${data.janela_media} dias)` 
                            : 'M√©dia do Per√≠odo',
                        data: data.dados.map(d => d.media),  // Valores da m√©dia
                        backgroundColor: gradientMedia,
                        borderColor: '#ef4444',  // Vermelho
                        borderWidth: 3,
                        tension: 0.4,
                        fill: tipoGrafico === 'line',  // Preenche apenas em linha
                        // Estilo dos pontos da m√©dia
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 7,
                        pointHoverBackgroundColor: '#dc2626',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 3,
                        pointStyle: 'rectRot',  // Formato diferente para distinguir
                        borderDash: [5, 5],  // Linha tracejada
                        order: 0  // Desenha por √∫ltimo (na frente)
                    });
                }

                consultasChart = new Chart(ctx, {
                    type: tipoGrafico,  // Tipo din√¢mico: 'line', 'bar', ou 'area'
                    data: {
                        labels: data.dados.map(d => d.data),  // Datas no eixo X
                        datasets: datasets
                    },
                    options: {
                        responsive: true,              // Adapta ao tamanho do container
                        maintainAspectRatio: false,    // Permite altura customizada
                        // Anima√ß√£o suave ao carregar
                        animation: {
                            duration: 1500,  // 1.5 segundos
                            easing: 'easeInOutQuart',  // Curva de anima√ß√£o suave
                        },
                        interaction: {
                            mode: 'index',  // Mostra todos os dados do mesmo √≠ndice
                            intersect: false,  // Tooltip aparece mesmo sem passar exatamente no ponto
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'end',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    padding: 15,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    color: '#64748b'
                                }
                            },
                            // Tooltip avan√ßado com informa√ß√µes detalhadas
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',  // Fundo escuro semi-transparente
                                padding: 16,
                                cornerRadius: 8,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold',
                                    family: "'Inter', sans-serif"
                                },
                                bodyFont: {
                                    size: 14,
                                    family: "'Inter', sans-serif"
                                },
                                bodySpacing: 8,
                                borderColor: '#6366f1',
                                borderWidth: 2,
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        return 'üìÖ ' + context[0].label;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y + ' consultas';
                                        return label;
                                    },
                                    afterLabel: function(context) {
                                        // Calcular porcentagem do total
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percent = ((context.parsed.y / total) * 100).toFixed(1);
                                        return percent + '% do total';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    font: {
                                        size: 12,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10
                                },
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                border: {
                                    display: false
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 12,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10
                                },
                                grid: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar consultas:', error);
        });
}

/**
 * Fun√ß√£o: carregarMedicamentos
 * Carrega e renderiza gr√°fico de medicamentos mais recomendados
 * @param {string} tipoGrafico - Tipo do gr√°fico ('bar', 'pie', ou 'doughnut')
 */
function carregarMedicamentos(tipoGrafico = 'bar') {
    const params = getFiltroParams();
    // Adiciona limite de medicamentos a exibir (10, 20, 50, etc.)
    params.append('limite', document.getElementById('limite-filter').value);
    
    const loading = document.getElementById('loading-medicamentos');
    loading.style.display = 'block';  // Exibe loading spinner
    
    fetch(`/api/estatisticas/medicamentos?${params}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('medicamentosChart').getContext('2d');
                
                // Destruir gr√°fico anterior se existir
                if (medicamentosChart) {
                    medicamentosChart.destroy();
                }
                
                // Configurar tipo de gr√°fico
                const chartType = tipoGrafico === 'horizontalBar' ? 'bar' : tipoGrafico;
                const indexAxis = tipoGrafico === 'horizontalBar' ? 'y' : 'x';
                
                // Paleta de cores moderna e vibrante (gradiente de azul para roxo/laranja)
                const coresPremium = [
                    '#6366f1',  // Indigo (prim√°ria)
                    '#8b5cf6',  // Violeta
                    '#a855f7',  // Roxo
                    '#d946ef',  // F√∫csia
                    '#ec4899',  // Rosa
                    '#f43f5e',  // Vermelho-Rosa
                    '#f97316',  // Laranja
                    '#f59e0b',  // √Çmbar
                    '#10b981',  // Verde Esmeralda
                    '#06b6d4'   // Ciano
                ];
                
                // Criar vers√µes com transpar√™ncia para hover
                const coresHover = coresPremium.map(cor => cor + 'dd');
                
                // Criar novo gr√°fico
                medicamentosChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: data.dados.map(d => d.medicamento),
                        datasets: [{
                            label: 'Medicamentos Recomendados',
                            data: data.dados.map(d => d.count),
                            backgroundColor: coresPremium,
                            hoverBackgroundColor: coresHover,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            borderRadius: 8,  // Bordas arredondadas nas barras
                            barThickness: 40  // Espessura das barras
                        }]
                    },
                    options: {
                        indexAxis: indexAxis,
                        responsive: true,
                        maintainAspectRatio: false,
                        // Anima√ß√£o suave ao carregar
                        animation: {
                            duration: 1200,
                            easing: 'easeInOutCubic',
                            delay: (context) => {
                                // Anima√ß√£o escalonada: cada barra aparece com delay
                                return context.dataIndex * 100;
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'end',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'rectRounded',
                                    padding: 15,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    color: '#64748b'
                                }
                            },
                            // Tooltip avan√ßado e colorido
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                padding: 16,
                                cornerRadius: 8,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold',
                                    family: "'Inter', sans-serif"
                                },
                                bodyFont: {
                                    size: 14,
                                    family: "'Inter', sans-serif"
                                },
                                bodySpacing: 8,
                                borderWidth: 2,
                                borderColor: (context) => {
                                    return coresPremium[context.dataIndex % coresPremium.length];
                                },
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        return 'üíä ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return 'Recomenda√ß√µes: ' + context.parsed.y + 'x';
                                    },
                                    afterLabel: function(context) {
                                        const percentual = data.dados[context.dataIndex].percentual;
                                        return 'üìä ' + percentual.toFixed(1) + '% do total';
                                    },
                                    footer: function(context) {
                                        const ranking = context[0].dataIndex + 1;
                                        return '\nüèÜ #' + ranking + '¬∞ mais recomendado';
                                    }
                                }
                            }
                        },
                        scales: {
                            [indexAxis === 'y' ? 'x' : 'y']: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    font: {
                                        size: 12,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10
                                },
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                border: {
                                    display: false
                                }
                            },
                            [indexAxis === 'y' ? 'y' : 'x']: {
                                ticks: {
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10
                                },
                                grid: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar medicamentos:', error);
        });
}

/**
 * Fun√ß√£o: carregarPacientes
 * Carrega e renderiza gr√°fico de distribui√ß√£o de pacientes
 * @param {string} agrupamento - Tipo de agrupamento ('faixa_etaria' ou 'genero')
 */
function carregarPacientes(agrupamento = 'faixa_etaria') {
    const loading = document.getElementById('loading-pacientes');
    loading.style.display = 'block';  // Exibe loading spinner
    
    fetch(`/api/estatisticas/pacientes?agrupamento=${agrupamento}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('pacientesChart').getContext('2d');
                
                // Destruir gr√°fico anterior se existir
                if (pacientesChart) {
                    pacientesChart.destroy();
                }
                
                // Paleta de cores vibrante e moderna
                const coresPacientes = [
                    '#6366f1',  // Indigo
                    '#8b5cf6',  // Violeta
                    '#06b6d4',  // Ciano
                    '#10b981',  // Verde
                    '#f59e0b',  // √Çmbar
                    '#ef4444',  // Vermelho
                    '#ec4899',  // Rosa
                    '#a855f7'   // Roxo
                ];
                
                // Vers√µes mais escuras para hover
                const coresHoverPacientes = [
                    '#4f46e5',
                    '#7c3aed',
                    '#0891b2',
                    '#059669',
                    '#d97706',
                    '#dc2626',
                    '#db2777',
                    '#9333ea'
                ];
                
                // Criar novo gr√°fico
                pacientesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.dados.map(d => d.categoria),
                        datasets: [{
                            label: 'Pacientes',
                            data: data.dados.map(d => d.count),
                            backgroundColor: coresPacientes,
                            hoverBackgroundColor: coresHoverPacientes,
                            borderColor: '#ffffff',
                            borderWidth: 3,
                            hoverBorderWidth: 4,
                            hoverOffset: 15,  // Aumenta offset no hover
                            spacing: 2  // Espa√ßo entre segmentos
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        // Anima√ß√£o suave e rotativa
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 1500,
                            easing: 'easeInOutQuart'
                        },
                        interaction: {
                            mode: 'nearest',
                            intersect: true
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    font: {
                                        size: 13,
                                        weight: '600',
                                        family: "'Inter', sans-serif"
                                    },
                                    color: '#64748b',
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percent = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label} - ${value} (${percent}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            // Tooltip avan√ßado e informativo
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                padding: 16,
                                cornerRadius: 8,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold',
                                    family: "'Inter', sans-serif"
                                },
                                bodyFont: {
                                    size: 14,
                                    family: "'Inter', sans-serif"
                                },
                                bodySpacing: 8,
                                borderWidth: 3,
                                borderColor: (context) => {
                                    return coresPacientes[context.dataIndex];
                                },
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        return 'üë• ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return 'Total: ' + context.parsed + ' pacientes';
                                    },
                                    afterLabel: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentual = (context.parsed / total * 100).toFixed(1);
                                        return 'üìä ' + percentual + '% do total';
                                    },
                                    footer: function(context) {
                                        const total = context[0].dataset.data.reduce((a, b) => a + b, 0);
                                        return '\nüìã Total geral: ' + total + ' pacientes';
                                    }
                                }
                            }
                        },
                        cutout: '65%',  // Mais fino para visual moderno
                        radius: '90%'   // Tamanho do gr√°fico
                    }
                });
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar pacientes:', error);
        });
}

/**
 * Fun√ß√£o: carregarSintomas
 * Carrega e renderiza gr√°fico de sintomas por faixa et√°ria
 * @param {string} tipoGrafico - Tipo do gr√°fico ('bar' ou 'doughnut')
 */
function carregarSintomas(tipoGrafico = 'bar') {
    const sintoma = document.getElementById('sintoma-filter').value;
    const periodo = document.getElementById('sintoma-periodo-filter').value;
    const loading = document.getElementById('loading-sintomas');
    
    loading.style.display = 'block';
    
    fetch(`/api/estatisticas/sintomas-faixa-etaria?sintoma=${sintoma}&periodo=${periodo}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('sintomasChart').getContext('2d');
                
                // Destruir gr√°fico anterior
                if (sintomasChart) {
                    sintomasChart.destroy();
                }
                
                // Atualizar dropdown de sintomas se necess√°rio
                const sintomaFilter = document.getElementById('sintoma-filter');
                const optionsAtuais = Array.from(sintomaFilter.options).map(opt => opt.value);
                
                // Adicionar novos sintomas ao dropdown
                data.sintomas_disponiveis.forEach(sint => {
                    if (!optionsAtuais.includes(sint)) {
                        const option = document.createElement('option');
                        option.value = sint;
                        option.textContent = sint.charAt(0).toUpperCase() + sint.slice(1).replace(/_/g, ' ');
                        sintomaFilter.appendChild(option);
                    }
                });
                
                // Paleta de cores moderna para faixas et√°rias
                const coresFaixas = ['#6366f1', '#8b5cf6', '#ec4899', '#f97316'];
                const coresHover = ['#4f46e5', '#7c3aed', '#db2777', '#ea580c'];
                
                // Criar gr√°fico
                sintomasChart = new Chart(ctx, {
                    type: tipoGrafico,
                    data: {
                        labels: data.dados.map(d => d.faixa_etaria),
                        datasets: [{
                            label: sintoma === 'todos' ? 'Todos os Sintomas' : sintoma,
                            data: data.dados.map(d => d.count),
                            backgroundColor: coresFaixas,
                            hoverBackgroundColor: coresHover,
                            borderColor: '#ffffff',
                            borderWidth: 3,
                            borderRadius: tipoGrafico === 'bar' ? 8 : 0,
                            barThickness: tipoGrafico === 'bar' ? 60 : undefined,
                            hoverOffset: tipoGrafico === 'doughnut' ? 15 : 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1200,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: {
                                display: tipoGrafico === 'doughnut',
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: 13,
                                        weight: '600'
                                    },
                                    color: '#64748b',
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label} - ${value} (${percent}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                padding: 16,
                                cornerRadius: 8,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 14
                                },
                                borderWidth: 2,
                                borderColor: (context) => coresFaixas[context.dataIndex % coresFaixas.length],
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        return 'üë• ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return 'Ocorr√™ncias: ' + context.parsed + (tipoGrafico === 'bar' ? '' : ' casos');
                                    },
                                    afterLabel: function(context) {
                                        const percentual = data.dados[context.dataIndex].percentual;
                                        return 'üìä ' + percentual + '% do total';
                                    },
                                    footer: function(context) {
                                        return '\nüìã Total: ' + data.total_ocorrencias + ' casos';
                                    }
                                }
                            }
                        },
                        scales: tipoGrafico === 'bar' ? {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    font: { size: 12, weight: '500' },
                                    color: '#64748b'
                                },
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)',
                                    drawBorder: false
                                },
                                border: { display: false }
                            },
                            x: {
                                ticks: {
                                    font: { size: 12, weight: '500' },
                                    color: '#64748b'
                                },
                                grid: { display: false },
                                border: { display: false }
                            }
                        } : {},
                        cutout: tipoGrafico === 'doughnut' ? '65%' : undefined,
                        radius: tipoGrafico === 'doughnut' ? '90%' : undefined
                    }
                });
                
                // Exibir badge de valida√ß√£o
                const validacaoBadge = document.getElementById('validacao-badge');
                if (data.validacao.consistente) {
                    validacaoBadge.className = 'status-badge success';
                    validacaoBadge.textContent = `‚úì Dados consistentes (${data.validacao.soma_faixas} de ${data.validacao.total_esperado})`;
                    validacaoBadge.style.display = 'inline-block';
                } else {
                    validacaoBadge.className = 'status-badge warning';
                    validacaoBadge.textContent = `‚ö† Inconsist√™ncia detectada (${data.validacao.soma_faixas} ‚â† ${data.validacao.total_esperado})`;
                    validacaoBadge.style.display = 'inline-block';
                }
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar sintomas:', error);
        });
}

// ==========================================
// EVENT LISTENERS PARA ALTERN√ÇNCIA DE GR√ÅFICOS
// Permite mudar entre linha/barra/pizza etc
// ==========================================

/**
 * Event Listener: Bot√µes de tipo de gr√°fico
 * Detecta clique nos bot√µes "Linha", "Barra", "Pizza" etc.
 * e recarrega o gr√°fico correspondente com o novo tipo
 */
document.querySelectorAll('.chart-option-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const chart = this.dataset.chart;  // Qual gr√°fico: consultas, medicamentos, pacientes
        
        // Remover classe 'active' de todos os bot√µes do mesmo grupo
        document.querySelectorAll(`[data-chart="${chart}"]`).forEach(b => b.classList.remove('active'));
        
        // Adicionar classe 'active' ao bot√£o clicado (destaque visual)
        this.classList.add('active');
        
        // Recarregar gr√°fico com novo tipo/agrupamento selecionado
        if (chart === 'consultas') {
            carregarConsultas(this.dataset.type);
        } else if (chart === 'medicamentos') {
            carregarMedicamentos(this.dataset.type);
        } else if (chart === 'pacientes') {
            carregarPacientes(this.dataset.agrupamento);
        } else if (chart === 'sintomas') {
            carregarSintomas(this.dataset.type);
        }
    });
});

// ==========================================
// EVENT LISTENERS PARA FILTROS DE SINTOMAS
// Atualiza gr√°fico quando sintoma ou per√≠odo mudam
// ==========================================

/**
 * Event Listener: Mudan√ßa no filtro de sintoma
 * Recarrega o gr√°fico quando o usu√°rio seleciona outro sintoma
 */
document.getElementById('sintoma-filter').addEventListener('change', function() {
    carregarSintomas();
});

/**
 * Event Listener: Mudan√ßa no filtro de per√≠odo de sintomas
 * Recarrega o gr√°fico quando o usu√°rio seleciona outro per√≠odo
 */
document.getElementById('sintoma-periodo-filter').addEventListener('change', function() {
    carregarSintomas();
});

// ==========================================
// INICIALIZA√á√ÉO
// Carrega todos os dados ao abrir a p√°gina
// ==========================================

/**
 * Event Listener: DOMContentLoaded
 * Aguarda carregamento completo do DOM antes de
 * carregar dados das APIs (evita erros de elementos n√£o encontrados)
 */
document.addEventListener('DOMContentLoaded', function() {
    // Carregar dados iniciais com filtros padr√£o (√∫ltimo m√™s)
    aplicarFiltros();
});
</script>
{% endblock %}

