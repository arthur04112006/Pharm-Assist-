{% extends "base.html" %}

{% block title %}Estatísticas Avançadas - Pharm-Assist{% endblock %}

{% block extra_css %}
<!-- Chart.js - Biblioteca de gráficos interativos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* =====================================================
       ESTATÍSTICAS AVANÇADAS - ESTILOS PERSONALIZADOS
       
       Este arquivo contém os estilos para a página de
       estatísticas avançadas com filtros dinâmicos e
       gráficos interativos usando Chart.js.
       
       Estrutura:
       1. Painel de Filtros
       2. Cards de Métricas
       3. Cards de Gráficos
       4. Loading States
       5. Responsividade
       ===================================================== */

    /* ==========================================
       1. PAINEL DE FILTROS
       Área superior com controles de filtro
       ========================================== */
    
    .filters-panel {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        border-left: 4px solid var(--primary-color); /* Borda azul usando variável do projeto */
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-group label {
        font-weight: 600;
        color: #475569;
        margin-bottom: 0.5rem;
        display: block;
    }

    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 0.95rem;
    }

    /* Efeito de foco nos campos de filtro */
    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: var(--primary-color); /* Usa cor primária do projeto */
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); /* Sombra azul sutil */
    }

    /* Botão principal de aplicar filtros */
    .btn-filter {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); /* Gradiente azul do projeto */
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease; /* Transição suave */
    }

    /* Efeito hover no botão de filtro */
    .btn-filter:hover {
        transform: translateY(-2px); /* Eleva o botão */
        box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); /* Sombra mais intensa */
    }

    .btn-reset {
        background: white;
        color: var(--text-secondary);
        border: 2px solid #e2e8f0;
        padding: 0.75rem 2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-left: 0.5rem;
    }

    .btn-reset:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    /* ==========================================
       2. CARDS DE MÉTRICAS
       Cards informativos com animações hover
       ========================================== */
    
    .metric-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease; /* Transição suave para hover */
        border-left: 4px solid; /* Borda colorida à esquerda */
        position: relative;
        overflow: hidden;
    }

    /* Efeito hover nos cards - eleva e aumenta sombra */
    .metric-card:hover {
        transform: translateY(-5px); /* Eleva o card */
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* Sombra mais pronunciada */
    }

    /* Card azul - Total de Consultas (usa cor primária do projeto) */
    .metric-card.primary {
        border-left-color: var(--primary-color);
    }

    /* Card verde - Taxa de Resolução (usa cor de sucesso do projeto) */
    .metric-card.success {
        border-left-color: var(--success-color);
    }

    /* Card azul claro - Pacientes Atendidos (usa cor info do projeto) */
    .metric-card.info {
        border-left-color: var(--info-color);
    }

    /* Card amarelo - Encaminhamentos (usa cor warning do projeto) */
    .metric-card.warning {
        border-left-color: var(--warning-color);
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .metric-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 500;
    }

    .metric-icon {
        font-size: 2rem;
        opacity: 0.3;
        float: right;
    }

    /* ==========================================
       3. CARDS DE GRÁFICOS
       Containers para os gráficos Chart.js
       ========================================== */
    
    /* Card principal que contém cada gráfico */
    .chart-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        transition: box-shadow 0.3s ease; /* Transição suave no hover */
    }

    /* Efeito hover sutil no card */
    .chart-card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* Header do card com título e botões de opção */
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f1f5f9;  /* Linha separadora sutil */
        flex-wrap: wrap;  /* Permite quebra em telas pequenas */
        gap: 1rem;
    }

    /* Título do gráfico */
    .chart-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    /* Subtítulo/descrição do gráfico */
    .chart-subtitle {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    /* Container responsivo para gráficos Chart.js */
    .chart-container {
        position: relative;
        height: 400px;  /* Altura padrão (ajustada por media queries) */
        margin: 1rem 0;
        width: 100%;    /* Largura total para responsividade */
    }

    /* Container dos botões de tipo de gráfico (Linha/Barra/Pizza) */
    .chart-options {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;  /* Permite quebra em mobile */
    }

    /* Botões de opção de tipo de gráfico (Linha, Barra, Pizza) */
    .chart-option-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s ease;  /* Transição suave */
        font-weight: 500;
    }

    /* Estado ativo do botão (tipo de gráfico selecionado) */
    .chart-option-btn.active {
        background: var(--primary-color);      /* Azul do projeto */
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);  /* Sombra azul */
    }

    /* Hover em botões não ativos */
    .chart-option-btn:hover:not(.active) {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: rgba(99, 102, 241, 0.05);  /* Fundo azul muito sutil */
    }

    /* ==========================================
       4. LOADING STATES
       Spinner animado durante carregamento de dados
       ========================================== */
    
    .loading-spinner {
        display: none;          /* Oculto por padrão, exibido via JavaScript */
        text-align: center;
        padding: 2rem;
    }

    /* Spinner circular rotativo */
    .spinner {
        border: 4px solid #f3f4f6;                  /* Borda cinza clara */
        border-top: 4px solid var(--primary-color); /* Topo azul (cor do projeto) */
        border-radius: 50%;                         /* Forma circular */
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;         /* Animação contínua */
        margin: 0 auto;
    }

    /* Animação de rotação do spinner */
    @keyframes spin {
        0% { transform: rotate(0deg); }      /* Início: 0 graus */
        100% { transform: rotate(360deg); }  /* Fim: 360 graus (volta completa) */
    }

    /* Status Badge */
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-badge.success {
        background: #d1fae5;
        color: #065f46;
    }

    .status-badge.warning {
        background: #fef3c7;
        color: #92400e;
    }

    .status-badge.info {
        background: #dbeafe;
        color: #1e40af;
    }

    /* ==========================================
       5. RESPONSIVIDADE
       Ajustes para diferentes tamanhos de tela
       Mobile-first approach
       ========================================== */
    
    /* Tablets e dispositivos médios (max-width: 992px) */
    @media (max-width: 992px) {
        /* Reduz padding do painel de filtros em tablets */
        .filters-panel {
            padding: 1rem;
        }
        
        /* Ajusta altura dos gráficos para tablets */
        .chart-container {
            height: 350px;
        }
        
        /* Garante espaçamento entre cards de métricas */
        .metric-card {
            margin-bottom: 1rem;
        }
        
        /* Ajusta título dos gráficos */
        .chart-title {
            font-size: 1.1rem;
        }
    }
    
    /* Smartphones e dispositivos pequenos (max-width: 768px) */
    @media (max-width: 768px) {
        /* Reduz altura dos gráficos em mobile para melhor visualização */
        .chart-container {
            height: 300px;
        }
        
        /* Ajusta tamanho dos valores das métricas para mobile */
        .metric-value {
            font-size: 1.75rem;
        }
        
        /* Reduz tamanho do título dos gráficos */
        .chart-title {
            font-size: 1rem;
        }
        
        /* Subtítulo menor em mobile */
        .chart-subtitle {
            font-size: 0.75rem;
        }
        
        /* Botões de opção de gráfico menores */
        .chart-option-btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
        }
        
        /* Filtros ocupam largura total */
        .filter-group {
            margin-bottom: 0.75rem;
        }
        
        /* Botões de filtro em largura total */
        .btn-filter,
        .btn-reset {
            width: 100%;
            margin: 0.25rem 0;
        }
        
        /* Reduz padding dos cards */
        .chart-card {
            padding: 1rem;
        }
    }
    
    /* Dispositivos muito pequenos (max-width: 480px) */
    @media (max-width: 480px) {
        /* Altura mínima para gráficos em telas muito pequenas */
        .chart-container {
            height: 250px;
        }
        
        /* Valores das métricas ainda menores para telas pequenas */
        .metric-value {
            font-size: 1.5rem;
        }
        
        /* Ícones das métricas menores */
        .metric-icon {
            font-size: 1.5rem;
        }
        
        /* Padding reduzido nos cards */
        .chart-card,
        .metric-card {
            padding: 1rem;
        }
        
        /* Opções de gráfico em coluna para telas pequenas */
        .chart-options {
            flex-direction: column;
            gap: 0.25rem;
            width: 100%;
        }
        
        /* Botões de opção ocupam largura total */
        .chart-option-btn {
            width: 100%;
        }
        
        /* Ajusta header do gráfico para mobile */
        .chart-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }
    
    /* Dispositivos com orientação paisagem (landscape) */
    @media (max-height: 600px) and (orientation: landscape) {
        /* Reduz altura dos gráficos em modo paisagem */
        .chart-container {
            height: 250px;
        }
        
        /* Reduz padding vertical */
        .chart-card,
        .metric-card {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Cabeçalho -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-graph-up text-primary"></i>
        Estatísticas Avançadas
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
        </a>
    </div>
</div>

<!-- Painel de Filtros -->
<div class="filters-panel">
    <div class="row">
        <div class="col-md-3">
            <div class="filter-group">
                <label for="periodo-filter">
                    <i class="bi bi-calendar3"></i> Período
                </label>
                <select id="periodo-filter" class="form-select">
                    <option value="dia">Hoje</option>
                    <option value="7dias">Últimos 7 Dias</option>
                    <option value="30dias" selected>Últimos 30 Dias</option>
                    <option value="90dias">Últimos 90 Dias</option>
                    <option value="ano">Último Ano</option>
                    <option value="personalizado">Personalizado</option>
                </select>
            </div>
        </div>
        
        <div class="col-md-3" id="data-inicio-group" style="display: none;">
            <div class="filter-group">
                <label for="data-inicio">
                    <i class="bi bi-calendar-check"></i> Data Início
                </label>
                <input type="date" id="data-inicio" class="form-control">
            </div>
        </div>
        
        <div class="col-md-3" id="data-fim-group" style="display: none;">
            <div class="filter-group">
                <label for="data-fim">
                    <i class="bi bi-calendar-check"></i> Data Fim
                </label>
                <input type="date" id="data-fim" class="form-control">
            </div>
        </div>
        
        <div class="col-md-12 d-flex justify-content-center mt-3">
            <button class="btn-filter" onclick="aplicarFiltros()">
                <i class="bi bi-funnel"></i> Aplicar Filtros
            </button>
            <button class="btn-reset" onclick="resetarFiltros()">
                <i class="bi bi-x-circle"></i> Limpar
            </button>
        </div>
    </div>
</div>

<!-- Cards de Métricas -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card primary">
            <i class="bi bi-clipboard-pulse metric-icon"></i>
            <div class="metric-value" id="metric-consultas">--</div>
            <div class="metric-label">Total de Consultas</div>
            <div class="mt-2">
                <span class="status-badge info" id="periodo-badge">Último Mês</span>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card warning">
            <i class="bi bi-exclamation-triangle metric-icon"></i>
            <div class="metric-value" id="metric-encaminhamentos">--</div>
            <div class="metric-label">Encaminhamentos</div>
            <div class="mt-2">
                <span class="status-badge warning" id="taxa-encaminhamento">--</span>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card success">
            <i class="bi bi-check-circle metric-icon"></i>
            <div class="metric-value" id="metric-resolucao">--</div>
            <div class="metric-label">Taxa de Resolução</div>
            <div class="mt-2">
                <span class="status-badge success" id="taxa-resolucao-badge">--</span>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="metric-card info">
            <i class="bi bi-people metric-icon"></i>
            <div class="metric-value" id="metric-pacientes">--</div>
            <div class="metric-label">Pacientes Atendidos</div>
            <div class="mt-2">
                <span class="status-badge info" id="media-dia">--</span>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="row">
    <!-- Gráfico de Consultas por Dia -->
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <div class="chart-title">
                        <i class="bi bi-graph-up-arrow text-primary"></i>
                        Consultas por Período
                    </div>
                    <div class="chart-subtitle">Evolução temporal das consultas realizadas</div>
                </div>
                <div class="chart-options">
                    <button class="chart-option-btn active" data-chart="consultas" data-type="line">
                        <i class="bi bi-graph-up"></i> Linha
                    </button>
                    <button class="chart-option-btn" data-chart="consultas" data-type="bar">
                        <i class="bi bi-bar-chart"></i> Barras
                    </button>
                </div>
            </div>
            <div class="loading-spinner" id="loading-consultas">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="consultasChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gráfico de Sintomas Mais Comuns -->
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div style="flex: 1;">
                    <div class="chart-title">
                        <i class="bi bi-clipboard-pulse text-danger"></i>
                        Sintomas Mais Comuns
                    </div>
                    <div class="chart-subtitle">Ranking dos sintomas mais frequentes no período selecionado</div>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Filtro de Período -->
                    <select id="sintomas-comuns-periodo-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="7dias">Últimos 7 Dias</option>
                        <option value="30dias" selected>Últimos 30 Dias</option>
                        <option value="90dias">Últimos 90 Dias</option>
                        <option value="ano">Último Ano</option>
                    </select>
                    
                    <!-- Filtro de Top -->
                    <select id="sintomas-comuns-top-filter" class="form-select" style="width: auto; min-width: 120px;">
                        <option value="5">Top 5</option>
                        <option value="10" selected>Top 10</option>
                        <option value="15">Top 15</option>
                        <option value="20">Top 20</option>
                        <option value="todos">Todos</option>
                    </select>
                </div>
            </div>
            <div class="loading-spinner" id="loading-sintomas-comuns">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="sintomasComunsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Novo: Gráfico de Sintomas por Faixa Etária -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div style="flex: 1;">
                    <div class="chart-title">
                        <i class="bi bi-people-fill text-info"></i>
                        Sintomas por Faixa Etária
                    </div>
                    <div class="chart-subtitle">Distribuição de sintomas por grupos de idade</div>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Filtro de Sintoma -->
                    <select id="sintoma-filter" class="form-select" style="width: auto; min-width: 200px;">
                        <option value="todos">Todos os Sintomas</option>
                        <!-- Opções serão carregadas dinamicamente -->
                    </select>
                    
                    <!-- Filtro de Período -->
                    <select id="sintoma-periodo-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="7dias">Últimos 7 Dias</option>
                        <option value="30dias" selected>Últimos 30 Dias</option>
                        <option value="90dias">Últimos 90 Dias</option>
                        <option value="ano">Último Ano</option>
                    </select>
                </div>
            </div>
            <div class="loading-spinner" id="loading-sintomas">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="sintomasChart"></canvas>
            </div>
            <!-- Badge de validação -->
            <div class="mt-3 text-center">
                <span id="validacao-badge" class="status-badge info" style="display: none;"></span>
            </div>
        </div>
    </div>
</div>

<!-- Novo: Gráfico de Sintomas por Gênero -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div style="flex: 1;">
                    <div class="chart-title">
                        <i class="bi bi-gender-ambiguous text-success"></i>
                        Sintomas por Gênero
                    </div>
                    <div class="chart-subtitle">Distribuição de sintomas por gênero (Masculino, Feminino, Outro)</div>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Filtro de Sintoma -->
                    <select id="sintoma-genero-filter" class="form-select" style="width: auto; min-width: 200px;">
                        <option value="todos">Todos os Sintomas</option>
                        <!-- Opções serão carregadas dinamicamente -->
                    </select>
                    
                    <!-- Filtro de Período -->
                    <select id="genero-periodo-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="7dias">Últimos 7 Dias</option>
                        <option value="30dias" selected>Últimos 30 Dias</option>
                        <option value="90dias">Últimos 90 Dias</option>
                        <option value="ano">Último Ano</option>
                    </select>
                </div>
            </div>
            <div class="loading-spinner" id="loading-genero">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="generoChart"></canvas>
            </div>
            <!-- Badge de validação e limitações -->
            <div class="mt-3 text-center">
                <span id="validacao-genero-badge" class="status-badge info" style="display: none;"></span>
            </div>
        </div>
    </div>
</div>

<!-- Novo: Gráfico de Sintomas por Localização (Bairro/Cidade) -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div style="flex: 1;">
                    <div class="chart-title">
                        <i class="bi bi-geo-alt-fill text-primary"></i>
                        Sintomas por Localização
                    </div>
                    <div class="chart-subtitle">Distribuição de sintomas por bairro ou cidade</div>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Filtro de Agrupamento -->
                    <select id="localizacao-agrupamento-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="bairro">Por Bairro</option>
                        <option value="cidade">Por Cidade</option>
                    </select>
                    
                    <!-- Filtro de Sintoma -->
                    <select id="sintoma-localizacao-filter" class="form-select" style="width: auto; min-width: 200px;">
                        <option value="todos">Todos os Sintomas</option>
                        <!-- Opções serão carregadas dinamicamente -->
                    </select>
                    
                    <!-- Filtro de Período -->
                    <select id="localizacao-periodo-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="7dias">Últimos 7 Dias</option>
                        <option value="30dias" selected>Últimos 30 Dias</option>
                        <option value="90dias">Últimos 90 Dias</option>
                        <option value="ano">Último Ano</option>
                    </select>
                </div>
            </div>
            <div class="loading-spinner" id="loading-localizacao">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="localizacaoChart"></canvas>
            </div>
            <!-- Badge de validação -->
            <div class="mt-3 text-center">
                <span id="validacao-localizacao-badge" class="status-badge info" style="display: none;"></span>
            </div>
        </div>
    </div>
</div>

<!-- Novo: Gráfico de Medicamentos por Sintoma -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div style="flex: 1;">
                    <div class="chart-title">
                        <i class="bi bi-capsule-pill text-primary"></i>
                        Medicamentos Mais Usados por Sintoma
                    </div>
                    <div class="chart-subtitle">Ranking de medicamentos por score (frequência + eficácia + gravidade)</div>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Filtro de Sintoma (obrigatório) -->
                    <select id="medicamentos-sintoma-filter" class="form-select" style="width: auto; min-width: 200px;">
                        <option value="">Selecione um sintoma</option>
                        <!-- Opções serão carregadas dinamicamente -->
                    </select>
                    
                    <!-- Filtro de Período -->
                    <select id="medicamentos-sintoma-periodo-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="7dias">Últimos 7 Dias</option>
                        <option value="30dias" selected>Últimos 30 Dias</option>
                        <option value="90dias">Últimos 90 Dias</option>
                        <option value="ano">Último Ano</option>
                    </select>
                    
                    <!-- Filtro de Gênero -->
                    <select id="medicamentos-sintoma-genero-filter" class="form-select" style="width: auto; min-width: 120px;">
                        <option value="todos">Todos</option>
                        <option value="M">Masculino</option>
                        <option value="F">Feminino</option>
                        <option value="O">Outro</option>
                    </select>
                    
                    <!-- Filtro de Faixa Etária -->
                    <select id="medicamentos-sintoma-faixa-filter" class="form-select" style="width: auto; min-width: 120px;">
                        <option value="todos">Todas</option>
                        <option value="0-17">0-17 anos</option>
                        <option value="18-34">18-34 anos</option>
                        <option value="35-54">35-54 anos</option>
                        <option value="55+">55+ anos</option>
                    </select>
                </div>
            </div>
            <div class="loading-spinner" id="loading-medicamentos-sintoma">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="medicamentosSintomaChart"></canvas>
            </div>
            <!-- Informação sobre score -->
            <div class="mt-3 text-center">
                <small class="text-muted" id="score-info" style="display: none;">
                    <i class="bi bi-info-circle"></i> 
                    Score = Frequência × 1.0 + Casos de Sucesso × 0.3 + Score Total da Triagem × 0.1
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico de Medicamentos Mais Recomendados -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <div class="chart-title">
                        <i class="bi bi-capsule text-warning"></i>
                        Medicamentos Mais Recomendados
                    </div>
                    <div class="chart-subtitle">Ranking de medicamentos por frequência de recomendação</div>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Filtro de Top -->
                    <select id="medicamentos-top-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="5">Top 5</option>
                        <option value="10" selected>Top 10</option>
                        <option value="15">Top 15</option>
                        <option value="20">Top 20</option>
                        <option value="todos">Todos</option>
                    </select>
                </div>
            </div>
            <div class="loading-spinner" id="loading-medicamentos">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="medicamentosChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico de Tipos de Recomendações (Farmacológica vs Não-Farmacológica) -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div style="flex: 1;">
                    <div class="chart-title">
                        <i class="bi bi-pie-chart-fill text-info"></i>
                        Tipos de Recomendações
                    </div>
                    <div class="chart-subtitle">Distribuição entre recomendações farmacológicas e não-farmacológicas</div>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Filtro de Período -->
                    <select id="tipos-recomendacoes-periodo-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="7dias">Últimos 7 Dias</option>
                        <option value="30dias" selected>Últimos 30 Dias</option>
                        <option value="90dias">Últimos 90 Dias</option>
                        <option value="ano">Último Ano</option>
                    </select>
                    
                    <!-- Filtro de Sintoma -->
                    <select id="tipos-recomendacoes-sintoma-filter" class="form-select" style="width: auto; min-width: 200px;">
                        <option value="todos">Todos os Sintomas</option>
                        <!-- Opções serão carregadas dinamicamente -->
                    </select>
                </div>
            </div>
            <div class="loading-spinner" id="loading-tipos-recomendacoes">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="tiposRecomendacoesChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico de Taxa de Encaminhamentos ao Longo do Tempo -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div style="flex: 1;">
                    <div class="chart-title">
                        <i class="bi bi-graph-up text-danger"></i>
                        Taxa de Encaminhamentos ao Longo do Tempo
                    </div>
                    <div class="chart-subtitle">Evolução da taxa de encaminhamentos médicos e resolução</div>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Filtro de Período -->
                    <select id="encaminhamentos-periodo-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="7dias">Últimos 7 Dias</option>
                        <option value="30dias" selected>Últimos 30 Dias</option>
                        <option value="90dias">Últimos 90 Dias</option>
                        <option value="ano">Último Ano</option>
                    </select>
                    
                    <!-- Filtro de Gênero -->
                    <select id="encaminhamentos-genero-filter" class="form-select" style="width: auto; min-width: 120px;">
                        <option value="todos">Todos</option>
                        <option value="M">Masculino</option>
                        <option value="F">Feminino</option>
                        <option value="O">Outro</option>
                    </select>
                    
                    <!-- Filtro de Faixa Etária -->
                    <select id="encaminhamentos-faixa-filter" class="form-select" style="width: auto; min-width: 120px;">
                        <option value="todos">Todas</option>
                        <option value="0-17">0-17 anos</option>
                        <option value="18-34">18-34 anos</option>
                        <option value="35-54">35-54 anos</option>
                        <option value="55+">55+ anos</option>
                    </select>
                </div>
            </div>
            <div class="loading-spinner" id="loading-encaminhamentos">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="encaminhamentosChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico de Distribuição de Hábitos -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div style="flex: 1;">
                    <div class="chart-title">
                        <i class="bi bi-person-heart text-warning"></i>
                        Distribuição de Hábitos
                    </div>
                    <div class="chart-subtitle">Distribuição de pacientes fumantes e etilistas</div>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Filtro de Período -->
                    <select id="habitos-periodo-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="todos">Todos</option>
                        <option value="7dias">Últimos 7 Dias</option>
                        <option value="30dias">Últimos 30 Dias</option>
                        <option value="90dias">Últimos 90 Dias</option>
                        <option value="ano">Último Ano</option>
                    </select>
                    
                    <!-- Filtro de Gênero -->
                    <select id="habitos-genero-filter" class="form-select" style="width: auto; min-width: 120px;">
                        <option value="todos">Todos</option>
                        <option value="M">Masculino</option>
                        <option value="F">Feminino</option>
                        <option value="O">Outro</option>
                    </select>
                    
                    <!-- Filtro de Faixa Etária -->
                    <select id="habitos-faixa-filter" class="form-select" style="width: auto; min-width: 120px;">
                        <option value="todos">Todas</option>
                        <option value="0-17">0-17 anos</option>
                        <option value="18-34">18-34 anos</option>
                        <option value="35-54">35-54 anos</option>
                        <option value="55+">55+ anos</option>
                    </select>
                </div>
            </div>
            <div class="loading-spinner" id="loading-habitos">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="habitosChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico de Recomendações Não-Farmacológicas Mais Comuns -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <div style="flex: 1;">
                    <div class="chart-title">
                        <i class="bi bi-heart-pulse text-success"></i>
                        Recomendações Não-Farmacológicas Mais Comuns
                    </div>
                    <div class="chart-subtitle">Ranking das recomendações não-farmacológicas mais frequentes</div>
                </div>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <!-- Filtro de Período -->
                    <select id="nao-farmacologicas-periodo-filter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="7dias">Últimos 7 Dias</option>
                        <option value="30dias" selected>Últimos 30 Dias</option>
                        <option value="90dias">Últimos 90 Dias</option>
                        <option value="ano">Último Ano</option>
                    </select>
                    
                    <!-- Filtro de Sintoma -->
                    <select id="nao-farmacologicas-sintoma-filter" class="form-select" style="width: auto; min-width: 200px;">
                        <option value="todos">Todos os Sintomas</option>
                        <!-- Opções serão carregadas dinamicamente -->
                    </select>
                    
                    <!-- Filtro de Top -->
                    <select id="nao-farmacologicas-top-filter" class="form-select" style="width: auto; min-width: 120px;">
                        <option value="5">Top 5</option>
                        <option value="10" selected>Top 10</option>
                        <option value="15">Top 15</option>
                        <option value="20">Top 20</option>
                        <option value="todos">Todos</option>
                    </select>
                </div>
            </div>
            <div class="loading-spinner" id="loading-nao-farmacologicas">
                <div class="spinner"></div>
                <p class="mt-2 text-muted">Carregando dados...</p>
            </div>
            <div class="chart-container">
                <canvas id="naoFarmacologicasChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* =====================================================
   ESTATÍSTICAS AVANÇADAS - JAVASCRIPT
   
   Este arquivo contém toda a lógica JavaScript para:
   - Gerenciamento de filtros dinâmicos
   - Chamadas às APIs de estatísticas
   - Criação e atualização de gráficos Chart.js
   - Manipulação de eventos de UI
   
   Estrutura:
   1. Variáveis globais e configurações
   2. Event listeners
   3. Funções de filtros
   4. Funções de carregamento de dados
   5. Funções de criação de gráficos
   ===================================================== */

// ==========================================
// 1. VARIÁVEIS GLOBAIS E CONFIGURAÇÕES
// ==========================================

// Instâncias dos gráficos Chart.js (para atualização dinâmica)
let consultasChart = null;      // Gráfico de consultas por período
let medicamentosChart = null;   // Gráfico de medicamentos mais recomendados
let sintomasChart = null;       // Gráfico de sintomas por faixa etária
let generoChart = null;         // Gráfico de sintomas por gênero
let localizacaoChart = null;    // Gráfico de sintomas por localização
let medicamentosSintomaChart = null; // Gráfico de medicamentos por sintoma
let sintomasComunsChart = null; // Gráfico de sintomas mais comuns
let tiposRecomendacoesChart = null; // Gráfico de tipos de recomendações
let encaminhamentosChart = null; // Gráfico de encaminhamentos ao longo do tempo
let habitosChart = null; // Gráfico de distribuição de hábitos
let naoFarmacologicasChart = null; // Gráfico de recomendações não-farmacológicas

// Configurações padrão do Chart.js (aplica-se a todos os gráficos)
Chart.defaults.font.family = 'Inter, sans-serif';  // Fonte consistente com o projeto
Chart.defaults.color = '#64748b';                  // Cor padrão de texto dos gráficos

// ==========================================
// 2. EVENT LISTENERS
// Gerencia eventos de UI e interações do usuário
// ==========================================

/**
 * Event Listener: Mudança no filtro de período
 * Exibe/oculta campos de data personalizada conforme seleção
 */
document.getElementById('periodo-filter').addEventListener('change', function() {
    const periodo = this.value;
    const dataInicioGroup = document.getElementById('data-inicio-group');
    const dataFimGroup = document.getElementById('data-fim-group');
    
    // Se período personalizado for selecionado, mostra campos de data
    if (periodo === 'personalizado') {
        dataInicioGroup.style.display = 'block';
        dataFimGroup.style.display = 'block';
        
        // Definir datas padrão (hoje e um mês atrás)
        const hoje = new Date();
        const umMesAtras = new Date();
        umMesAtras.setMonth(umMesAtras.getMonth() - 1);
        
        document.getElementById('data-fim').valueAsDate = hoje;
        document.getElementById('data-inicio').valueAsDate = umMesAtras;
    } else {
        // Oculta campos de data para períodos pré-definidos
        dataInicioGroup.style.display = 'none';
        dataFimGroup.style.display = 'none';
    }
});


// ==========================================
// 3. FUNÇÕES DE FILTROS
// Gerenciam aplicação e reset de filtros
// ==========================================

/**
 * Função: aplicarFiltros
 * Aplica todos os filtros selecionados e recarrega todos os gráficos
 * Chamada quando o usuário clica em "Aplicar Filtros"
 */
function aplicarFiltros() {
    carregarDesempenho();               // Atualiza cards de métricas
    carregarConsultas();                // Atualiza gráfico de consultas
    carregarSintomasComuns();           // Atualiza gráfico de sintomas mais comuns
    carregarSintomas();                 // Atualiza gráfico de sintomas
    carregarGenero();                   // Atualiza gráfico de gênero
    carregarLocalizacao();              // Atualiza gráfico de localização
    carregarMedicamentosPorSintoma();   // Atualiza gráfico de medicamentos por sintoma
    carregarMedicamentos();             // Atualiza gráfico de medicamentos mais recomendados
    carregarTiposRecomendacoes();       // Atualiza gráfico de tipos de recomendações
    carregarEncaminhamentos();          // Atualiza gráfico de encaminhamentos
    carregarHabitos();                  // Atualiza gráfico de hábitos
    carregarNaoFarmacologicas();        // Atualiza gráfico de recomendações não-farmacológicas
}

/**
 * Função: resetarFiltros
 * Restaura filtros para valores padrão e recarrega dados
 * Chamada quando o usuário clica em "Limpar"
 */
function resetarFiltros() {
    // Restaurar valores padrão
    document.getElementById('periodo-filter').value = '30dias';
    
    // Ocultar campos de data personalizada
    document.getElementById('data-inicio-group').style.display = 'none';
    document.getElementById('data-fim-group').style.display = 'none';
    
    // Reaplicar filtros com valores padrão
    aplicarFiltros();
}

/**
 * Função: getFiltroParams
 * Constrói parâmetros de URL baseado nos filtros selecionados
 * @returns {URLSearchParams} - Objeto com parâmetros para requisições API
 */
function getFiltroParams() {
    const periodo = document.getElementById('periodo-filter').value;
    const params = new URLSearchParams();
    
    // Se período personalizado, usa datas específicas
    if (periodo === 'personalizado') {
        const dataInicio = document.getElementById('data-inicio').value;
        const dataFim = document.getElementById('data-fim').value;
        if (dataInicio && dataFim) {
            params.append('data_inicio', dataInicio);
            params.append('data_fim', dataFim);
        }
    } else {
        // Caso contrário, usa período pré-definido
        params.append('periodo', periodo);
    }
    
    // Usar média móvel de 7 dias por padrão (acompanha a tendência)
    params.append('tipo_media', 'movel');
    params.append('janela_media', '7');
    
    return params;
}

// ==========================================
// 4. FUNÇÕES DE CARREGAMENTO DE DADOS
// Fazem requisições às APIs e atualizam a UI
// ==========================================

/**
 * Função: carregarDesempenho
 * Carrega métricas de desempenho do sistema via API
 * Atualiza os 4 cards de métricas no topo da página
 */
function carregarDesempenho() {
    const params = getFiltroParams();
    
    // Chamada à API de desempenho
    fetch(`/api/estatisticas/desempenho?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const m = data.metricas;
                
                // Atualizar valores principais dos cards
                document.getElementById('metric-consultas').textContent = m.total_consultas;
                document.getElementById('metric-encaminhamentos').textContent = m.total_encaminhamentos;
                document.getElementById('metric-resolucao').textContent = m.taxa_resolucao + '%';
                document.getElementById('metric-pacientes').textContent = m.total_pacientes_atendidos;
                
                // Atualizar badges informativos
                document.getElementById('taxa-encaminhamento').textContent = m.taxa_encaminhamento + '% encaminhados';
                document.getElementById('taxa-resolucao-badge').textContent = m.taxa_resolucao + '% resolvidos';
                document.getElementById('media-dia').textContent = m.media_consultas_dia + ' consultas/dia';
                
                // Atualizar badge de período selecionado
                const periodoTexto = {
                    'dia': 'Hoje',
                    '7dias': 'Últimos 7 Dias',
                    '30dias': 'Últimos 30 Dias',
                    '90dias': 'Últimos 90 Dias',
                    'semana': 'Última Semana',
                    'mes': 'Último Mês',
                    'ano': 'Último Ano',
                    'personalizado': 'Período Personalizado'
                };
                document.getElementById('periodo-badge').textContent = periodoTexto[data.periodo] || 'Últimos 30 Dias';
            }
        })
        .catch(error => console.error('Erro ao carregar desempenho:', error));
}

/**
 * Função: carregarConsultas
 * Carrega e renderiza gráfico de consultas por período
 * @param {string} tipoGrafico - Tipo do gráfico ('line', 'bar', ou 'area')
 */
function carregarConsultas(tipoGrafico = 'line') {
    const params = getFiltroParams();
    const loading = document.getElementById('loading-consultas');
    loading.style.display = 'block';  // Exibe loading spinner
    
    fetch(`/api/estatisticas/consultas?${params}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('consultasChart').getContext('2d');
                
                // Destruir gráfico anterior se existir (evita duplicação)
                if (consultasChart) {
                    consultasChart.destroy();
                }
                
                // ==========================================
                // 5. CRIAÇÃO DO GRÁFICO DE CONSULTAS
                // Usa Chart.js com cores do projeto
                // ==========================================
                
                // Criar gradiente para o gráfico
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)');
                gradient.addColorStop(0.5, 'rgba(99, 102, 241, 0.25)');
                gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

                // Criar datasets para o gráfico
                const datasets = [{
                    label: 'Consultas Realizadas',
                    data: data.dados.map(d => d.count),  // Quantidade de consultas
                    // Gradiente moderno para área sob a linha
                    backgroundColor: tipoGrafico === 'line' ? gradient : 'rgba(99, 102, 241, 0.8)',
                    borderColor: '#6366f1',  // Azul primário
                    borderWidth: 3,  // Linha mais grossa
                    tension: 0.4,  // Suavização da linha (curvas suaves)
                    fill: true,    // Preenche área sob a linha
                    // Estilo dos pontos (marcadores)
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 9,  // Aumenta significativamente no hover
                    pointHoverBackgroundColor: '#4f46e5',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3,
                    // Sombra nos pontos
                    pointStyle: 'circle',
                    // Borda com gradiente
                    borderCapStyle: 'round',
                    borderJoinStyle: 'round',
                    order: 1  // Desenha primeiro (atrás)
                }];
                
                // Adicionar linha de média se disponível
                if (data.dados.length > 0 && data.dados[0].media !== undefined) {
                    // Criar gradiente para a linha de média
                    const gradientMedia = ctx.createLinearGradient(0, 0, 0, 400);
                    gradientMedia.addColorStop(0, 'rgba(239, 68, 68, 0.2)');
                    gradientMedia.addColorStop(1, 'rgba(239, 68, 68, 0.0)');
                    
                    datasets.push({
                        label: data.tipo_media === 'movel' 
                            ? `Média Móvel (${data.janela_media} dias)` 
                            : 'Média do Período',
                        data: data.dados.map(d => d.media),  // Valores da média
                        backgroundColor: gradientMedia,
                        borderColor: '#ef4444',  // Vermelho
                        borderWidth: 3,
                        tension: 0.4,
                        fill: tipoGrafico === 'line',  // Preenche apenas em linha
                        // Estilo dos pontos da média
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 7,
                        pointHoverBackgroundColor: '#dc2626',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 3,
                        pointStyle: 'rectRot',  // Formato diferente para distinguir
                        borderDash: [5, 5],  // Linha tracejada
                        order: 0  // Desenha por último (na frente)
                    });
                }

                consultasChart = new Chart(ctx, {
                    type: tipoGrafico,  // Tipo dinâmico: 'line', 'bar', ou 'area'
                    data: {
                        labels: data.dados.map(d => d.data),  // Datas no eixo X
                        datasets: datasets
                    },
                    options: {
                        responsive: true,              // Adapta ao tamanho do container
                        maintainAspectRatio: false,    // Permite altura customizada
                        // Animação suave ao carregar
                        animation: {
                            duration: 1500,  // 1.5 segundos
                            easing: 'easeInOutQuart',  // Curva de animação suave
                        },
                        interaction: {
                            mode: 'index',  // Mostra todos os dados do mesmo índice
                            intersect: false,  // Tooltip aparece mesmo sem passar exatamente no ponto
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'end',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    padding: 15,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    color: '#64748b'
                                }
                            },
                            // Tooltip avançado com informações detalhadas
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',  // Fundo escuro semi-transparente
                                padding: 16,
                                cornerRadius: 8,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold',
                                    family: "'Inter', sans-serif"
                                },
                                bodyFont: {
                                    size: 14,
                                    family: "'Inter', sans-serif"
                                },
                                bodySpacing: 8,
                                borderColor: '#6366f1',
                                borderWidth: 2,
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        return '📅 ' + context[0].label;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y + ' consultas';
                                        return label;
                                    },
                                    afterLabel: function(context) {
                                        // Calcular porcentagem do total
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percent = ((context.parsed.y / total) * 100).toFixed(1);
                                        return percent + '% do total';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    font: {
                                        size: 12,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10
                                },
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                border: {
                                    display: false
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 12,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10
                                },
                                grid: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar consultas:', error);
        });
}

/**
 * Função: carregarMedicamentos
 * Carrega e renderiza gráfico de medicamentos mais recomendados
 * Sempre usa gráfico horizontal com filtro de Top N
 */
function carregarMedicamentos() {
    const params = getFiltroParams();
    // Não passa limite - API retorna todos, filtramos no frontend
    
    const loading = document.getElementById('loading-medicamentos');
    loading.style.display = 'block';  // Exibe loading spinner
    
    fetch(`/api/estatisticas/medicamentos?${params}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                // Aplicar filtro de Top N
                const topFilter = document.getElementById('medicamentos-top-filter').value;
                let dadosFiltrados = [...data.dados];
                
                if (topFilter !== 'todos') {
                    const topN = parseInt(topFilter);
                    dadosFiltrados = data.dados.slice(0, topN);
                }
                
                const ctx = document.getElementById('medicamentosChart').getContext('2d');
                
                // Destruir gráfico anterior se existir
                if (medicamentosChart) {
                    medicamentosChart.destroy();
                }
                
                // Sempre usar gráfico horizontal
                const chartType = 'bar';
                const indexAxis = 'y'; // Horizontal
                
                // Paleta de cores moderna e vibrante (gradiente de azul para roxo/laranja)
                // Expandida para suportar muitos medicamentos (sem limite)
                const coresBase = [
                    '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899',
                    '#f43f5e', '#f97316', '#f59e0b', '#10b981', '#06b6d4',
                    '#3b82f6', '#14b8a6', '#f59e0b', '#ef4444', '#a855f7',
                    '#8b5cf6', '#ec4899', '#06b6d4', '#10b981', '#f97316'
                ];
                
                // Repetir cores se necessário para muitos medicamentos
                const coresPremium = [];
                for (let i = 0; i < dadosFiltrados.length; i++) {
                    coresPremium.push(coresBase[i % coresBase.length]);
                }
                
                // Criar versões com transparência para hover
                const coresHover = coresPremium.map(cor => cor + 'dd');
                
                // Criar novo gráfico
                medicamentosChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: dadosFiltrados.map(d => d.medicamento),
                        datasets: [{
                            label: 'Medicamentos Recomendados',
                            data: dadosFiltrados.map(d => d.count),
                            backgroundColor: coresPremium,
                            hoverBackgroundColor: coresHover,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            borderRadius: 8,  // Bordas arredondadas nas barras
                            barThickness: 40  // Espessura das barras
                        }]
                    },
                    options: {
                        indexAxis: indexAxis,
                        responsive: true,
                        maintainAspectRatio: false,
                        // Animação suave ao carregar
                        animation: {
                            duration: 1200,
                            easing: 'easeInOutCubic',
                            delay: (context) => {
                                // Animação escalonada: cada barra aparece com delay
                                return context.dataIndex * 100;
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'end',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'rectRounded',
                                    padding: 15,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    color: '#64748b'
                                }
                            },
                            // Tooltip avançado e colorido
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                padding: 16,
                                cornerRadius: 8,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold',
                                    family: "'Inter', sans-serif"
                                },
                                bodyFont: {
                                    size: 14,
                                    family: "'Inter', sans-serif"
                                },
                                bodySpacing: 8,
                                borderWidth: 2,
                                borderColor: (context) => {
                                    return coresPremium[context.dataIndex % coresPremium.length];
                                },
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        return '💊 ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return 'Recomendações: ' + context.parsed.y + 'x';
                                    },
                                    afterLabel: function(context) {
                                        const percentual = dadosFiltrados[context.dataIndex].percentual;
                                        return '📊 ' + percentual.toFixed(1) + '% do total';
                                    },
                                    footer: function(context) {
                                        const ranking = context[0].dataIndex + 1;
                                        const totalMostrado = topFilter === 'todos' ? data.dados.length : parseInt(topFilter);
                                        return '\n🏆 #' + ranking + '° mais recomendado' + (topFilter !== 'todos' ? ` (de ${totalMostrado} mostrados)` : '');
                                    }
                                }
                            }
                        },
                        scales: {
                            [indexAxis === 'y' ? 'x' : 'y']: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    font: {
                                        size: 12,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10
                                },
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                border: {
                                    display: false
                                }
                            },
                            [indexAxis === 'y' ? 'y' : 'x']: {
                                ticks: {
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10
                                },
                                grid: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar medicamentos:', error);
        });
}

/**
 * Função: carregarSintomas
 * Carrega e renderiza gráfico de sintomas por faixa etária
 * Sempre usa gráfico tipo pizza (doughnut)
 */
function carregarSintomas() {
    const tipoGrafico = 'doughnut'; // Sempre pizza
    const sintoma = document.getElementById('sintoma-filter').value;
    const periodo = document.getElementById('sintoma-periodo-filter').value;
    const loading = document.getElementById('loading-sintomas');
    
    loading.style.display = 'block';
    
    fetch(`/api/estatisticas/sintomas-faixa-etaria?sintoma=${sintoma}&periodo=${periodo}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('sintomasChart').getContext('2d');
                
                // Destruir gráfico anterior
                if (sintomasChart) {
                    sintomasChart.destroy();
                }
                
                // Atualizar dropdown de sintomas se necessário
                const sintomaFilter = document.getElementById('sintoma-filter');
                const optionsAtuais = Array.from(sintomaFilter.options).map(opt => opt.value);
                
                // Adicionar novos sintomas ao dropdown
                data.sintomas_disponiveis.forEach(sint => {
                    if (!optionsAtuais.includes(sint)) {
                        const option = document.createElement('option');
                        option.value = sint;
                        option.textContent = sint.charAt(0).toUpperCase() + sint.slice(1).replace(/_/g, ' ');
                        sintomaFilter.appendChild(option);
                    }
                });
                
                // Paleta de cores moderna para faixas etárias
                const coresFaixas = ['#6366f1', '#8b5cf6', '#ec4899', '#f97316'];
                const coresHover = ['#4f46e5', '#7c3aed', '#db2777', '#ea580c'];
                
                // Criar gráfico
                sintomasChart = new Chart(ctx, {
                    type: tipoGrafico, // Sempre 'doughnut' (pizza)
                    data: {
                        labels: data.dados.map(d => d.faixa_etaria),
                        datasets: [{
                            label: sintoma === 'todos' ? 'Todos os Sintomas' : sintoma,
                            data: data.dados.map(d => d.count),
                            backgroundColor: coresFaixas,
                            hoverBackgroundColor: coresHover,
                            borderColor: '#ffffff',
                            borderWidth: 3,
                            borderRadius: 0, // Pizza não precisa de borderRadius
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1200,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: {
                                display: true, // Sempre mostrar legenda (gráfico pizza)
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: 13,
                                        weight: '600'
                                    },
                                    color: '#64748b',
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label} - ${value} (${percent}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                padding: 16,
                                cornerRadius: 8,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 14
                                },
                                borderWidth: 2,
                                borderColor: (context) => coresFaixas[context.dataIndex % coresFaixas.length],
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        return '👥 ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return 'Ocorrências: ' + context.parsed + ' casos'; // Pizza sempre mostra "casos"
                                    },
                                    afterLabel: function(context) {
                                        const percentual = data.dados[context.dataIndex].percentual;
                                        return '📊 ' + percentual + '% do total';
                                    },
                                    footer: function(context) {
                                        return '\n📋 Total: ' + data.total_ocorrencias + ' casos';
                                    }
                                }
                            }
                        },
                        // Pizza não precisa de scales
                        cutout: '65%',
                        radius: '90%'
                    }
                });
                
                // Exibir badge de validação
                const validacaoBadge = document.getElementById('validacao-badge');
                if (data.validacao.consistente) {
                    validacaoBadge.className = 'status-badge success';
                    validacaoBadge.textContent = `✓ Dados consistentes (${data.validacao.soma_faixas} de ${data.validacao.total_esperado})`;
                    validacaoBadge.style.display = 'inline-block';
                } else {
                    validacaoBadge.className = 'status-badge warning';
                    validacaoBadge.textContent = `⚠ Inconsistência detectada (${data.validacao.soma_faixas} ≠ ${data.validacao.total_esperado})`;
                    validacaoBadge.style.display = 'inline-block';
                }
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar sintomas:', error);
        });
}

// ==========================================
// EVENT LISTENERS PARA ALTERNÂNCIA DE GRÁFICOS
// Permite mudar entre linha/barra/pizza etc
// ==========================================

/**
 * Event Listener: Botões de tipo de gráfico
 * Detecta clique nos botões "Linha", "Barra", "Pizza" etc.
 * e recarrega o gráfico correspondente com o novo tipo
 */
document.querySelectorAll('.chart-option-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const chart = this.dataset.chart;  // Qual gráfico: consultas, medicamentos, pacientes
        
        // Remover classe 'active' de todos os botões do mesmo grupo
        document.querySelectorAll(`[data-chart="${chart}"]`).forEach(b => b.classList.remove('active'));
        
        // Adicionar classe 'active' ao botão clicado (destaque visual)
        this.classList.add('active');
        
        // Recarregar gráfico com novo tipo/agrupamento selecionado
        if (chart === 'consultas') {
            carregarConsultas(this.dataset.type);
        } else if (chart === 'medicamentos') {
            carregarMedicamentos(); // Sempre horizontal
        } else if (chart === 'sintomas') {
            carregarSintomas(); // Sempre pizza
        } else if (chart === 'genero') {
            carregarGenero(); // Sempre pizza
        } else if (chart === 'localizacao') {
            carregarLocalizacao(); // Sempre barras
        }
    });
});

// ==========================================
// EVENT LISTENERS PARA FILTROS DE SINTOMAS
// Atualiza gráfico quando sintoma ou período mudam
// ==========================================

/**
 * Event Listener: Mudança no filtro de sintoma
 * Recarrega o gráfico quando o usuário seleciona outro sintoma
 */
document.getElementById('sintoma-filter').addEventListener('change', function() {
    carregarSintomas();
});

/**
 * Event Listener: Mudança no filtro de período de sintomas
 * Recarrega o gráfico quando o usuário seleciona outro período
 */
document.getElementById('sintoma-periodo-filter').addEventListener('change', function() {
    carregarSintomas();
});

// ==========================================
// EVENT LISTENERS PARA FILTROS DE GÊNERO
// Atualiza gráfico quando sintoma ou período mudam
// ==========================================

/**
 * Event Listener: Mudança no filtro de sintoma (gênero)
 * Recarrega o gráfico quando o usuário seleciona outro sintoma
 */
document.getElementById('sintoma-genero-filter').addEventListener('change', function() {
    carregarGenero();
});

/**
 * Event Listener: Mudança no filtro de período de gênero
 * Recarrega o gráfico quando o usuário seleciona outro período
 */
document.getElementById('genero-periodo-filter').addEventListener('change', function() {
    carregarGenero();
});

// ==========================================
// EVENT LISTENERS PARA FILTROS DE MEDICAMENTOS
// Atualiza gráfico quando filtro de Top muda
// ==========================================

/**
 * Event Listener: Mudança no filtro de Top de medicamentos
 * Recarrega o gráfico quando o usuário seleciona outro Top N
 */
document.getElementById('medicamentos-top-filter').addEventListener('change', function() {
    carregarMedicamentos();
});

// ==========================================
// EVENT LISTENERS PARA FILTROS DE LOCALIZAÇÃO
// Atualiza gráfico quando agrupamento, sintoma ou período mudam
// ==========================================

/**
 * Event Listener: Mudança no filtro de agrupamento (bairro/cidade)
 * Recarrega o gráfico quando o usuário seleciona outro agrupamento
 */
document.getElementById('localizacao-agrupamento-filter').addEventListener('change', function() {
    carregarLocalizacao();
});

/**
 * Event Listener: Mudança no filtro de sintoma (localização)
 * Recarrega o gráfico quando o usuário seleciona outro sintoma
 */
document.getElementById('sintoma-localizacao-filter').addEventListener('change', function() {
    carregarLocalizacao();
});

/**
 * Event Listener: Mudança no filtro de período de localização
 * Recarrega o gráfico quando o usuário seleciona outro período
 */
document.getElementById('localizacao-periodo-filter').addEventListener('change', function() {
    carregarLocalizacao();
});

// ==========================================
// EVENT LISTENERS PARA FILTROS DE MEDICAMENTOS POR SINTOMA
// ==========================================

/**
 * Event Listener: Mudança no filtro de sintoma (medicamentos por sintoma)
 */
document.getElementById('medicamentos-sintoma-filter').addEventListener('change', function() {
    carregarMedicamentosPorSintoma();
});

/**
 * Event Listener: Mudança no filtro de período (medicamentos por sintoma)
 */
document.getElementById('medicamentos-sintoma-periodo-filter').addEventListener('change', function() {
    carregarMedicamentosPorSintoma();
});

/**
 * Event Listener: Mudança no filtro de gênero (medicamentos por sintoma)
 */
document.getElementById('medicamentos-sintoma-genero-filter').addEventListener('change', function() {
    carregarMedicamentosPorSintoma();
});

/**
 * Event Listener: Mudança no filtro de faixa etária (medicamentos por sintoma)
 */
document.getElementById('medicamentos-sintoma-faixa-filter').addEventListener('change', function() {
    carregarMedicamentosPorSintoma();
});

/**
 * Função: carregarGenero
 * Carrega e renderiza gráfico de sintomas por gênero
 * Sempre usa gráfico tipo pizza (doughnut)
 */
function carregarGenero() {
    const tipoGrafico = 'doughnut'; // Sempre pizza
    const sintoma = document.getElementById('sintoma-genero-filter').value;
    const periodo = document.getElementById('genero-periodo-filter').value;
    const loading = document.getElementById('loading-genero');
    
    loading.style.display = 'block';
    
    fetch(`/api/estatisticas/sintomas-genero?sintoma=${sintoma}&periodo=${periodo}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('generoChart').getContext('2d');
                
                // Destruir gráfico anterior
                if (generoChart) {
                    generoChart.destroy();
                }
                
                // Atualizar dropdown de sintomas se necessário
                const sintomaFilter = document.getElementById('sintoma-genero-filter');
                const optionsAtuais = Array.from(sintomaFilter.options).map(opt => opt.value);
                
                // Adicionar novos sintomas ao dropdown
                data.sintomas_disponiveis.forEach(sint => {
                    if (!optionsAtuais.includes(sint)) {
                        const option = document.createElement('option');
                        option.value = sint;
                        option.textContent = sint.charAt(0).toUpperCase() + sint.slice(1).replace(/_/g, ' ');
                        sintomaFilter.appendChild(option);
                    }
                });
                
                // Paleta de cores para gênero (consistente e clara)
                const coresGenero = ['#3b82f6', '#ec4899', '#a855f7'];  // Azul, Rosa, Roxo
                const coresHover = ['#2563eb', '#db2777', '#9333ea'];
                
                // Criar gráfico
                generoChart = new Chart(ctx, {
                    type: tipoGrafico, // Sempre 'doughnut' (pizza)
                    data: {
                        labels: data.dados.map(d => d.genero),
                        datasets: [{
                            label: sintoma === 'todos' ? 'Todos os Sintomas' : sintoma,
                            data: data.dados.map(d => d.count),
                            backgroundColor: coresGenero,
                            hoverBackgroundColor: coresHover,
                            borderColor: '#ffffff',
                            borderWidth: 3,
                            borderRadius: 0, // Pizza não precisa de borderRadius
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1200,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: {
                                display: true, // Sempre mostrar legenda (gráfico pizza)
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: 13,
                                        weight: '600'
                                    },
                                    color: '#64748b',
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label} - ${value} (${percent}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                padding: 16,
                                cornerRadius: 8,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 14
                                },
                                borderWidth: 2,
                                borderColor: (context) => coresGenero[context.dataIndex % coresGenero.length],
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        const icons = {'Masculino': '♂️', 'Feminino': '♀️', 'Outro': '⚧'};
                                        return icons[context[0].label] + ' ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return 'Ocorrências: ' + context.parsed + ' casos'; // Pizza sempre mostra "casos"
                                    },
                                    afterLabel: function(context) {
                                        const percentual = data.dados[context.dataIndex].percentual;
                                        return '📊 ' + percentual + '% do total';
                                    },
                                    footer: function(context) {
                                        return '\n📋 Total: ' + data.total_ocorrencias + ' casos';
                                    }
                                }
                            }
                        },
                        // Pizza não precisa de scales
                        cutout: '65%',
                        radius: '90%'
                    }
                });
                
                // Exibir badge de validação e limitações
                const validacaoBadge = document.getElementById('validacao-genero-badge');
                let badgeText = '';
                
                if (data.validacao.consistente) {
                    validacaoBadge.className = 'status-badge success';
                    badgeText = `✓ Dados consistentes (${data.validacao.soma_generos} de ${data.validacao.total_esperado})`;
                } else {
                    validacaoBadge.className = 'status-badge warning';
                    badgeText = `⚠ Inconsistência detectada (${data.validacao.soma_generos} ≠ ${data.validacao.total_esperado})`;
                }
                
                // Adicionar informação sobre dados sem gênero se houver
                if (data.validacao.dados_sem_genero > 0) {
                    badgeText += ` | ${data.validacao.dados_sem_genero} registros sem gênero`;
                }
                
                // Adicionar informação sobre campo obrigatório
                if (data.limitacoes.campo_obrigatorio) {
                    badgeText += ' | Campo gênero: OBRIGATÓRIO ✓';
                }
                
                validacaoBadge.textContent = badgeText;
                validacaoBadge.style.display = 'inline-block';
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar gênero:', error);
        });
}

/**
 * Função: carregarLocalizacao
 * Carrega e renderiza gráfico de sintomas por localização (bairro/cidade)
 * Sempre usa gráfico tipo barras (bar)
 */
function carregarLocalizacao() {
    const tipoGrafico = 'bar'; // Sempre barras
    const agrupamento = document.getElementById('localizacao-agrupamento-filter').value;
    const sintoma = document.getElementById('sintoma-localizacao-filter').value;
    const periodo = document.getElementById('localizacao-periodo-filter').value;
    const loading = document.getElementById('loading-localizacao');
    
    loading.style.display = 'block';
    
    fetch(`/api/estatisticas/sintomas-localizacao?sintoma=${sintoma}&periodo=${periodo}&agrupamento=${agrupamento}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('localizacaoChart').getContext('2d');
                
                // Destruir gráfico anterior
                if (localizacaoChart) {
                    localizacaoChart.destroy();
                }
                
                // Atualizar dropdown de sintomas se necessário
                const sintomaFilter = document.getElementById('sintoma-localizacao-filter');
                const optionsAtuais = Array.from(sintomaFilter.options).map(opt => opt.value);
                
                // Adicionar novos sintomas ao dropdown
                data.sintomas_disponiveis.forEach(sint => {
                    if (!optionsAtuais.includes(sint)) {
                        const option = document.createElement('option');
                        option.value = sint;
                        option.textContent = sint.charAt(0).toUpperCase() + sint.slice(1).replace(/_/g, ' ');
                        sintomaFilter.appendChild(option);
                    }
                });
                
                // Paleta de cores moderna para localização (gradiente de cores)
                const coresLocalizacao = [
                    '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899',
                    '#f43f5e', '#f97316', '#f59e0b', '#10b981', '#06b6d4',
                    '#3b82f6', '#14b8a6', '#f59e0b', '#ef4444', '#a855f7'
                ];
                const coresHover = coresLocalizacao.map(cor => {
                    // Escurecer ligeiramente para hover
                    return cor.replace('#', '').split('').map((c, i) => {
                        if (i % 2 === 0) {
                            const val = parseInt(c, 16);
                            return (val > 0 ? val - 1 : 0).toString(16);
                        }
                        return c;
                    }).join('');
                }).map(cor => '#' + cor);
                
                // Criar gráfico
                localizacaoChart = new Chart(ctx, {
                    type: tipoGrafico, // Sempre 'bar' (barras)
                    data: {
                        labels: data.dados.map(d => d.localizacao),
                        datasets: [{
                            label: sintoma === 'todos' ? 'Todos os Sintomas' : sintoma,
                            data: data.dados.map(d => d.count),
                            backgroundColor: coresLocalizacao.slice(0, data.dados.length),
                            hoverBackgroundColor: coresHover.slice(0, data.dados.length),
                            borderColor: '#ffffff',
                            borderWidth: 3,
                            borderRadius: 8, // Barras sempre com bordas arredondadas
                            barThickness: 50
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1200,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: {
                                display: tipoGrafico === 'doughnut',
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    color: '#64748b',
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label} - ${value} (${percent}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                padding: 16,
                                cornerRadius: 8,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 14
                                },
                                borderWidth: 2,
                                borderColor: (context) => coresLocalizacao[context.dataIndex % coresLocalizacao.length],
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        const agrupamentoAtual = document.getElementById('localizacao-agrupamento-filter').value;
                                        const icon = agrupamentoAtual === 'bairro' ? '🏘️' : '🏙️';
                                        return icon + ' ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return 'Ocorrências: ' + context.parsed; // Barras não mostram "casos"
                                    },
                                    afterLabel: function(context) {
                                        const percentual = data.dados[context.dataIndex].percentual;
                                        return '📊 ' + percentual + '% do total';
                                    },
                                    footer: function(context) {
                                        return '\n📋 Total: ' + data.total_ocorrencias + ' casos';
                                    }
                                }
                            }
                        },
                        // Barras sempre precisam de scales
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    font: { size: 12, weight: '500' },
                                    color: '#64748b'
                                },
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)',
                                    drawBorder: false
                                },
                                border: { display: false }
                            },
                            x: {
                                ticks: {
                                    font: { size: 11, weight: '500' },
                                    color: '#64748b',
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: { display: false },
                                border: { display: false }
                            }
                        }
                    }
                });
                
                // Exibir badge de validação
                const validacaoBadge = document.getElementById('validacao-localizacao-badge');
                let badgeText = '';
                
                if (data.validacao.consistente) {
                    validacaoBadge.className = 'status-badge success';
                    badgeText = `✓ Dados consistentes (${data.validacao.soma_localizacoes} de ${data.validacao.total_esperado})`;
                } else {
                    validacaoBadge.className = 'status-badge warning';
                    badgeText = `⚠ Inconsistência detectada (${data.validacao.soma_localizacoes} ≠ ${data.validacao.total_esperado})`;
                }
                
                // Adicionar informação sobre dados sem localização se houver
                if (data.validacao.dados_sem_localizacao > 0) {
                    badgeText += ` | ${data.validacao.dados_sem_localizacao} registros sem ${agrupamento}`;
                }
                
                // Adicionar informação sobre campo opcional
                if (data.limitacoes.campo_opcional) {
                    badgeText += ' | Campos opcionais no cadastro';
                }
                
                validacaoBadge.textContent = badgeText;
                validacaoBadge.style.display = 'inline-block';
            } else {
                // Se não houver dados, mostrar mensagem
                const ctx = document.getElementById('localizacaoChart').getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Inter, sans-serif';
                ctx.fillStyle = '#64748b';
                ctx.textAlign = 'center';
                ctx.fillText('Nenhum dado disponível para o período selecionado', ctx.canvas.width / 2, ctx.canvas.height / 2);
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar localização:', error);
        });
}

/**
 * Função: carregarMedicamentosPorSintoma
 * Carrega e renderiza gráfico de medicamentos mais usados por sintoma
 * Sempre usa gráfico de barras horizontais ordenado por score
 */
function carregarMedicamentosPorSintoma() {
    const sintoma = document.getElementById('medicamentos-sintoma-filter').value;
    const periodo = document.getElementById('medicamentos-sintoma-periodo-filter').value;
    const genero = document.getElementById('medicamentos-sintoma-genero-filter').value;
    const faixaEtaria = document.getElementById('medicamentos-sintoma-faixa-filter').value;
    const loading = document.getElementById('loading-medicamentos-sintoma');
    
    // Validar se sintoma foi selecionado
    if (!sintoma) {
        const canvasEl = document.getElementById('medicamentosSintomaChart');
        if (canvasEl && medicamentosSintomaChart) {
            medicamentosSintomaChart.destroy();
            medicamentosSintomaChart = null;
        }
        const scoreInfo = document.getElementById('score-info');
        if (scoreInfo) {
            scoreInfo.style.display = 'none';
        }
        return;
    }
    
    loading.style.display = 'block';
    
    const params = new URLSearchParams({
        sintoma: sintoma,
        periodo: periodo,
        genero: genero,
        faixa_etaria: faixaEtaria
    });
    
    fetch(`/api/estatisticas/medicamentos-por-sintoma?${params}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('medicamentosSintomaChart').getContext('2d');
                
                // Destruir gráfico anterior se existir
                if (medicamentosSintomaChart) {
                    medicamentosSintomaChart.destroy();
                }
                
                // Se não houver medicamentos, mostrar mensagem
                if (!data.medicamentos || data.medicamentos.length === 0) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = '16px Inter, sans-serif';
                    ctx.fillStyle = '#64748b';
                    ctx.textAlign = 'center';
                    ctx.fillText('Nenhum medicamento encontrado para este sintoma no período selecionado', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    document.getElementById('score-info').style.display = 'none';
                    return;
                }
                
                // Paleta de cores moderna
                const coresBase = [
                    '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899',
                    '#f43f5e', '#f97316', '#f59e0b', '#10b981', '#06b6d4',
                    '#3b82f6', '#14b8a6', '#ef4444', '#a855f7', '#8b5cf6'
                ];
                
                // Repetir cores se necessário
                const coresPremium = [];
                for (let i = 0; i < data.medicamentos.length; i++) {
                    coresPremium.push(coresBase[i % coresBase.length]);
                }
                
                const coresHover = coresPremium.map(cor => cor + 'dd');
                
                // Criar gráfico de barras horizontais
                medicamentosSintomaChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.medicamentos.map(m => m.medicamento),
                        datasets: [{
                            label: 'Score',
                            data: data.medicamentos.map(m => m.score),
                            backgroundColor: coresPremium,
                            hoverBackgroundColor: coresHover,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 40
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Barras horizontais
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1200,
                            easing: 'easeInOutCubic',
                            delay: (context) => context.dataIndex * 50
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'end',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    color: '#64748b'
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                padding: 16,
                                cornerRadius: 8,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold',
                                    family: "'Inter', sans-serif"
                                },
                                bodyFont: {
                                    size: 14,
                                    family: "'Inter', sans-serif"
                                },
                                bodySpacing: 8,
                                borderWidth: 2,
                                borderColor: (context) => coresPremium[context.dataIndex % coresPremium.length],
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        return '💊 ' + context[0].label;
                                    },
                                    label: function(context) {
                                        const medicamento = data.medicamentos[context.dataIndex];
                                        return [
                                            `Score: ${medicamento.score}`,
                                            `Frequência: ${medicamento.frequencia} vezes`,
                                            `Taxa de sucesso: ${medicamento.taxa_sucesso}%`,
                                            `Casos: ${medicamento.total_casos} (${medicamento.casos_sucesso} sem encaminhamento)`
                                        ];
                                    },
                                    footer: function(context) {
                                        const ranking = context[0].dataIndex + 1;
                                        return `\n🏆 #${ranking}° medicamento mais usado para "${data.sintoma}"`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 1,
                                    font: {
                                        size: 12,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10
                                },
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)',
                                    drawBorder: false
                                },
                                border: { display: false },
                                title: {
                                    display: true,
                                    text: 'Score',
                                    font: {
                                        size: 13,
                                        weight: '600'
                                    },
                                    color: '#64748b'
                                }
                            },
                            y: {
                                ticks: {
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10,
                                    maxRotation: 45,
                                    minRotation: 0
                                },
                                grid: { display: false },
                                border: { display: false }
                            }
                        }
                    }
                });
                
                // Exibir informação sobre score
                document.getElementById('score-info').style.display = 'block';
                
                // Carregar sintomas disponíveis no dropdown se necessário
                carregarSintomasDisponiveisParaMedicamentos();
            } else {
                loading.style.display = 'none';
                console.error('Erro ao carregar medicamentos por sintoma:', data.error);
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar medicamentos por sintoma:', error);
        });
}

/**
 * Função: carregarSintomasDisponiveisParaMedicamentos
 * Carrega lista de sintomas disponíveis no dropdown
 */
function carregarSintomasDisponiveisParaMedicamentos() {
    // Usar a mesma lista de sintomas dos outros gráficos
    const sintomaFilter = document.getElementById('sintoma-filter');
    const medicamentosSintomaFilter = document.getElementById('medicamentos-sintoma-filter');
    
    if (sintomaFilter && medicamentosSintomaFilter) {
        const optionsAtuais = Array.from(medicamentosSintomaFilter.options).map(opt => opt.value);
        
        // Se já tem opções, não precisa recarregar
        if (optionsAtuais.length > 1) {
            return;
        }
        
        // Buscar sintomas da API de sintomas por faixa etária
        fetch('/api/estatisticas/sintomas-faixa-etaria?sintoma=todos&periodo=ano')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.sintomas_disponiveis) {
                    // Limpar opções existentes (exceto a primeira)
                    medicamentosSintomaFilter.innerHTML = '<option value="">Selecione um sintoma</option>';
                    
                    // Adicionar sintomas
                    data.sintomas_disponiveis.forEach(sint => {
                        const option = document.createElement('option');
                        option.value = sint;
                        option.textContent = sint.charAt(0).toUpperCase() + sint.slice(1).replace(/_/g, ' ');
                        medicamentosSintomaFilter.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Erro ao carregar sintomas:', error));
    }
}

// ==========================================
// INICIALIZAÇÃO
// Carrega todos os dados ao abrir a página
// ==========================================

/**
 * Event Listener: DOMContentLoaded
 * Aguarda carregamento completo do DOM antes de
 * carregar dados das APIs (evita erros de elementos não encontrados)
 */
document.addEventListener('DOMContentLoaded', function() {
    // Carregar dados iniciais com filtros padrão (último mês)
    aplicarFiltros();
    
    // Carregar sintomas disponíveis para o gráfico de medicamentos por sintoma
    carregarSintomasDisponiveisParaMedicamentos();
    
    // Carregar gráfico de sintomas mais comuns
    carregarSintomasComuns();
    
    // Carregar novos gráficos
    carregarTiposRecomendacoes();
    carregarEncaminhamentos();
    carregarHabitos();
    carregarNaoFarmacologicas();
});

/**
 * Função: carregarSintomasComuns
 * Carrega e renderiza gráfico de sintomas mais comuns
 * Sempre usa gráfico de barras horizontais ordenado por frequência
 */
function carregarSintomasComuns() {
    const periodo = document.getElementById('sintomas-comuns-periodo-filter').value;
    const top = document.getElementById('sintomas-comuns-top-filter').value;
    const loading = document.getElementById('loading-sintomas-comuns');
    
    loading.style.display = 'block';
    
    const params = new URLSearchParams({
        periodo: periodo,
        top: top
    });
    
    fetch(`/api/estatisticas/sintomas-comuns?${params}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('sintomasComunsChart').getContext('2d');
                
                // Destruir gráfico anterior se existir
                if (sintomasComunsChart) {
                    sintomasComunsChart.destroy();
                }
                
                // Se não houver dados, mostrar mensagem
                if (!data.dados || data.dados.length === 0) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = '16px Inter, sans-serif';
                    ctx.fillStyle = '#64748b';
                    ctx.textAlign = 'center';
                    ctx.fillText('Nenhum sintoma encontrado no período selecionado', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }
                
                // Paleta de cores moderna
                const coresBase = [
                    '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16',
                    '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#3b82f6',
                    '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'
                ];
                
                // Repetir cores se necessário
                const coresPremium = [];
                for (let i = 0; i < data.dados.length; i++) {
                    coresPremium.push(coresBase[i % coresBase.length]);
                }
                
                const coresHover = coresPremium.map(cor => cor + 'dd');
                
                // Criar gráfico de barras horizontais
                sintomasComunsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.dados.map(d => {
                            // Formatar nome do sintoma (capitalizar e substituir underscores)
                            return d.sintoma.charAt(0).toUpperCase() + d.sintoma.slice(1).replace(/_/g, ' ');
                        }),
                        datasets: [{
                            label: 'Frequência',
                            data: data.dados.map(d => d.count),
                            backgroundColor: coresPremium,
                            hoverBackgroundColor: coresHover,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 40
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Barras horizontais
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1200,
                            easing: 'easeInOutCubic',
                            delay: (context) => context.dataIndex * 50
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'end',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    color: '#64748b'
                                }
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                padding: 16,
                                cornerRadius: 8,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold',
                                    family: "'Inter', sans-serif"
                                },
                                bodyFont: {
                                    size: 14,
                                    family: "'Inter', sans-serif"
                                },
                                bodySpacing: 8,
                                borderWidth: 2,
                                borderColor: (context) => coresPremium[context.dataIndex % coresPremium.length],
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        return '🩺 ' + context[0].label;
                                    },
                                    label: function(context) {
                                        const sintoma = data.dados[context.dataIndex];
                                        return [
                                            `Ocorrências: ${sintoma.count}`,
                                            `Percentual: ${sintoma.percentual}% do total`,
                                            `Total de consultas: ${data.total_consultas}`
                                        ];
                                    },
                                    footer: function(context) {
                                        const ranking = context[0].dataIndex + 1;
                                        return `\n🏆 #${ranking}° sintoma mais comum`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0,
                                    font: {
                                        size: 12,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10
                                },
                                grid: {
                                    color: 'rgba(148, 163, 184, 0.1)',
                                    drawBorder: false
                                },
                                border: { display: false },
                                title: {
                                    display: true,
                                    text: 'Número de Ocorrências',
                                    font: {
                                        size: 13,
                                        weight: '600'
                                    },
                                    color: '#64748b'
                                }
                            },
                            y: {
                                ticks: {
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    },
                                    color: '#64748b',
                                    padding: 10,
                                    maxRotation: 45,
                                    minRotation: 0
                                },
                                grid: { display: false },
                                border: { display: false }
                            }
                        }
                    }
                });
            } else {
                loading.style.display = 'none';
                console.error('Erro ao carregar sintomas comuns:', data.error);
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar sintomas comuns:', error);
        });
}

/**
 * Função: carregarTiposRecomendacoes
 * Carrega e renderiza gráfico de pizza de tipos de recomendações
 */
function carregarTiposRecomendacoes() {
    const periodo = document.getElementById('tipos-recomendacoes-periodo-filter').value;
    const sintoma = document.getElementById('tipos-recomendacoes-sintoma-filter').value;
    const loading = document.getElementById('loading-tipos-recomendacoes');
    
    loading.style.display = 'block';
    
    const params = new URLSearchParams({
        periodo: periodo,
        sintoma: sintoma
    });
    
    fetch(`/api/estatisticas/tipos-recomendacoes?${params}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('tiposRecomendacoesChart').getContext('2d');
                
                if (tiposRecomendacoesChart) {
                    tiposRecomendacoesChart.destroy();
                }
                
                if (!data.dados || data.dados.length === 0) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = '16px Inter, sans-serif';
                    ctx.fillStyle = '#64748b';
                    ctx.textAlign = 'center';
                    ctx.fillText('Nenhuma recomendação encontrada no período selecionado', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }
                
                const cores = ['#6366f1', '#10b981'];
                const coresHover = ['#4f46e5', '#059669'];
                
                tiposRecomendacoesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.dados.map(d => d.tipo),
                        datasets: [{
                            label: 'Recomendações',
                            data: data.dados.map(d => d.count),
                            backgroundColor: cores.slice(0, data.dados.length),
                            hoverBackgroundColor: coresHover.slice(0, data.dados.length),
                            borderColor: '#ffffff',
                            borderWidth: 3,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 1500
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: 13,
                                        weight: '600'
                                    },
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percent = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label} - ${value} (${percent}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percent = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.parsed} (${percent}%)`;
                                    },
                                    footer: function(context) {
                                        return `Total: ${data.total} recomendações`;
                                    }
                                }
                            }
                        },
                        cutout: '65%'
                    }
                });
                
                // Carregar sintomas disponíveis se necessário
                carregarSintomasDisponiveisParaTiposRecomendacoes();
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar tipos de recomendações:', error);
        });
}

/**
 * Função: carregarEncaminhamentos
 * Carrega e renderiza gráfico de linha de taxa de encaminhamentos
 */
function carregarEncaminhamentos() {
    const periodo = document.getElementById('encaminhamentos-periodo-filter').value;
    const genero = document.getElementById('encaminhamentos-genero-filter').value;
    const faixaEtaria = document.getElementById('encaminhamentos-faixa-filter').value;
    const loading = document.getElementById('loading-encaminhamentos');
    
    loading.style.display = 'block';
    
    const params = new URLSearchParams({
        periodo: periodo,
        genero: genero,
        faixa_etaria: faixaEtaria
    });
    
    fetch(`/api/estatisticas/encaminhamentos-tempo?${params}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('encaminhamentosChart').getContext('2d');
                
                if (encaminhamentosChart) {
                    encaminhamentosChart.destroy();
                }
                
                if (!data.dados || data.dados.length === 0) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = '16px Inter, sans-serif';
                    ctx.fillStyle = '#64748b';
                    ctx.textAlign = 'center';
                    ctx.fillText('Nenhum dado encontrado no período selecionado', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }
                
                encaminhamentosChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dados.map(d => {
                            const date = new Date(d.data);
                            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                        }),
                        datasets: [{
                            label: 'Taxa de Encaminhamento (%)',
                            data: data.dados.map(d => d.taxa_encaminhamento),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Taxa de Resolução (%)',
                            data: data.dados.map(d => d.taxa_resolucao),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y}%`;
                                    },
                                    afterLabel: function(context) {
                                        const index = context.dataIndex;
                                        const dados = data.dados[index];
                                        return `Total: ${dados.total} consultas | Encaminhamentos: ${dados.encaminhamentos}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar encaminhamentos:', error);
        });
}

/**
 * Função: carregarHabitos
 * Carrega e renderiza gráfico de distribuição de hábitos
 */
function carregarHabitos() {
    const periodo = document.getElementById('habitos-periodo-filter').value;
    const genero = document.getElementById('habitos-genero-filter').value;
    const faixaEtaria = document.getElementById('habitos-faixa-filter').value;
    const loading = document.getElementById('loading-habitos');
    
    loading.style.display = 'block';
    
    const params = new URLSearchParams({
        periodo: periodo,
        genero: genero,
        faixa_etaria: faixaEtaria
    });
    
    fetch(`/api/estatisticas/habitos?${params}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('habitosChart').getContext('2d');
                
                if (habitosChart) {
                    habitosChart.destroy();
                }
                
                if (!data.dados || data.dados.length === 0) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = '16px Inter, sans-serif';
                    ctx.fillStyle = '#64748b';
                    ctx.textAlign = 'center';
                    ctx.fillText('Nenhum dado encontrado', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }
                
                const cores = ['#10b981', '#f59e0b', '#3b82f6', '#ef4444'];
                
                habitosChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.dados.map(d => d.categoria),
                        datasets: [{
                            label: 'Pacientes',
                            data: data.dados.map(d => d.count),
                            backgroundColor: cores.slice(0, data.dados.length),
                            borderRadius: 8,
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} pacientes (${data.dados[context.dataIndex].percentual}%)`;
                                    },
                                    footer: function() {
                                        return `Total: ${data.total} pacientes`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar hábitos:', error);
        });
}

/**
 * Função: carregarNaoFarmacologicas
 * Carrega e renderiza gráfico de recomendações não-farmacológicas mais comuns
 */
function carregarNaoFarmacologicas() {
    const periodo = document.getElementById('nao-farmacologicas-periodo-filter').value;
    const sintoma = document.getElementById('nao-farmacologicas-sintoma-filter').value;
    const top = document.getElementById('nao-farmacologicas-top-filter').value;
    const loading = document.getElementById('loading-nao-farmacologicas');
    
    loading.style.display = 'block';
    
    const params = new URLSearchParams({
        periodo: periodo,
        sintoma: sintoma,
        top: top
    });
    
    fetch(`/api/estatisticas/recomendacoes-nao-farmacologicas?${params}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.success) {
                const ctx = document.getElementById('naoFarmacologicasChart').getContext('2d');
                
                if (naoFarmacologicasChart) {
                    naoFarmacologicasChart.destroy();
                }
                
                if (!data.dados || data.dados.length === 0) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = '16px Inter, sans-serif';
                    ctx.fillStyle = '#64748b';
                    ctx.textAlign = 'center';
                    ctx.fillText('Nenhuma recomendação não-farmacológica encontrada', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }
                
                const coresBase = [
                    '#10b981', '#14b8a6', '#06b6d4', '#3b82f6', '#6366f1',
                    '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e'
                ];
                
                const coresPremium = [];
                for (let i = 0; i < data.dados.length; i++) {
                    coresPremium.push(coresBase[i % coresBase.length]);
                }
                
                const coresHover = coresPremium.map(cor => cor + 'dd');
                
                naoFarmacologicasChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.dados.map(d => d.recomendacao.length > 50 ? d.recomendacao.substring(0, 50) + '...' : d.recomendacao),
                        datasets: [{
                            label: 'Frequência',
                            data: data.dados.map(d => d.count),
                            backgroundColor: coresPremium,
                            hoverBackgroundColor: coresHover,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 40
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const index = context[0].dataIndex;
                                        return data.dados[index].recomendacao;
                                    },
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const rec = data.dados[index];
                                        return [
                                            `Frequência: ${rec.count}`,
                                            `Percentual: ${rec.percentual}%`
                                        ];
                                    },
                                    footer: function(context) {
                                        const ranking = context[0].dataIndex + 1;
                                        return `\n🏆 #${ranking}° recomendação mais comum`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            },
                            y: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            }
                        }
                    }
                });
                
                // Carregar sintomas disponíveis se necessário
                carregarSintomasDisponiveisParaNaoFarmacologicas();
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Erro ao carregar recomendações não-farmacológicas:', error);
        });
}

/**
 * Função auxiliar: carregar sintomas para filtro de tipos de recomendações
 */
function carregarSintomasDisponiveisParaTiposRecomendacoes() {
    const sintomaFilter = document.getElementById('tipos-recomendacoes-sintoma-filter');
    if (sintomaFilter && sintomaFilter.options.length <= 1) {
        fetch('/api/estatisticas/sintomas-faixa-etaria?sintoma=todos&periodo=ano')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.sintomas_disponiveis) {
                    sintomaFilter.innerHTML = '<option value="todos">Todos os Sintomas</option>';
                    data.sintomas_disponiveis.forEach(sint => {
                        const option = document.createElement('option');
                        option.value = sint;
                        option.textContent = sint.charAt(0).toUpperCase() + sint.slice(1).replace(/_/g, ' ');
                        sintomaFilter.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Erro ao carregar sintomas:', error));
    }
}

/**
 * Função auxiliar: carregar sintomas para filtro de recomendações não-farmacológicas
 */
function carregarSintomasDisponiveisParaNaoFarmacologicas() {
    const sintomaFilter = document.getElementById('nao-farmacologicas-sintoma-filter');
    if (sintomaFilter && sintomaFilter.options.length <= 1) {
        fetch('/api/estatisticas/sintomas-faixa-etaria?sintoma=todos&periodo=ano')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.sintomas_disponiveis) {
                    sintomaFilter.innerHTML = '<option value="todos">Todos os Sintomas</option>';
                    data.sintomas_disponiveis.forEach(sint => {
                        const option = document.createElement('option');
                        option.value = sint;
                        option.textContent = sint.charAt(0).toUpperCase() + sint.slice(1).replace(/_/g, ' ');
                        sintomaFilter.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Erro ao carregar sintomas:', error));
    }
}

// Event listeners para os novos gráficos
document.getElementById('tipos-recomendacoes-periodo-filter').addEventListener('change', carregarTiposRecomendacoes);
document.getElementById('tipos-recomendacoes-sintoma-filter').addEventListener('change', carregarTiposRecomendacoes);
document.getElementById('encaminhamentos-periodo-filter').addEventListener('change', carregarEncaminhamentos);
document.getElementById('encaminhamentos-genero-filter').addEventListener('change', carregarEncaminhamentos);
document.getElementById('encaminhamentos-faixa-filter').addEventListener('change', carregarEncaminhamentos);
document.getElementById('habitos-periodo-filter').addEventListener('change', carregarHabitos);
document.getElementById('habitos-genero-filter').addEventListener('change', carregarHabitos);
document.getElementById('habitos-faixa-filter').addEventListener('change', carregarHabitos);
document.getElementById('nao-farmacologicas-periodo-filter').addEventListener('change', carregarNaoFarmacologicas);
document.getElementById('nao-farmacologicas-sintoma-filter').addEventListener('change', carregarNaoFarmacologicas);
document.getElementById('nao-farmacologicas-top-filter').addEventListener('change', carregarNaoFarmacologicas);
</script>
{% endblock %}

